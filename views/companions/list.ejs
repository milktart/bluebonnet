<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/nav') %>

  <main class="container mt-4">
    <%- include('../partials/flash') %>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="bi bi-people"></i> Travel Companions</h1>
      <a href="/companions/create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add Companion
      </a>
    </div>

    <% if (companions.length === 0) { %>
      <div class="card text-center">
        <div class="card-body py-5">
          <i class="bi bi-people display-1 text-muted"></i>
          <h3 class="mt-3">No Travel Companions Yet</h3>
          <p class="text-muted">Add companions to easily include them in your trips</p>
          <a href="/companions/create" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Your First Companion
          </a>
        </div>
      </div>
    <% } else { %>
      <div class="row">
        <% companions.forEach(companion => { %>
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h5 class="card-title mb-0">
                    <%= companion.name %>
                    <% if (companion.linkedAccount) { %>
                      <span class="badge bg-success ms-2" title="Linked to account">
                        <i class="bi bi-person-check"></i>
                      </span>
                    <% } else { %>
                      <span class="badge bg-secondary ms-2" title="Not linked">
                        <i class="bi bi-person"></i>
                      </span>
                    <% } %>
                  </h5>
                  <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item" href="/companions/<%= companion.id %>/edit">
                        <i class="bi bi-pencil"></i> Edit
                      </a></li>
                      <% if (companion.linkedAccount) { %>
                        <li><a class="dropdown-item text-warning" href="#" onclick="unlinkCompanion('<%= companion.id %>')">
                          <i class="bi bi-unlink"></i> Unlink Account
                        </a></li>
                      <% } %>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item text-danger" href="#" onclick="deleteCompanion('<%= companion.id %>')">
                        <i class="bi bi-trash"></i> Delete
                      </a></li>
                    </ul>
                  </div>
                </div>

                <div class="mb-2">
                  <small class="text-muted">Email:</small><br>
                  <span><%= companion.email %></span>
                </div>

                <% if (companion.phone) { %>
                  <div class="mb-2">
                    <small class="text-muted">Phone:</small><br>
                    <span><%= companion.phone %></span>
                  </div>
                <% } %>

                <% if (companion.linkedAccount) { %>
                  <div class="mb-2">
                    <small class="text-muted">Linked Account:</small><br>
                    <span><%= companion.linkedAccount.firstName %> <%= companion.linkedAccount.lastName %></span>
                  </div>
                <% } %>

                <div class="mt-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="canBeAddedByOthers<%= companion.id %>"
                           <%= companion.canBeAddedByOthers ? 'checked' : '' %>
                           onchange="toggleCompanionPermission('<%= companion.id %>', this.checked)">
                    <label class="form-check-label" for="canBeAddedByOthers<%= companion.id %>">
                      <small>Allow others to add this companion to their trips</small>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteCompanionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Delete Travel Companion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this travel companion?</p>
            <p class="text-muted">This will remove them from all trips they are currently part of.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Unlink Confirmation Modal -->
    <div class="modal fade" id="unlinkCompanionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Unlink Account</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to unlink this companion's account?</p>
            <p class="text-muted">They will no longer be able to see trips you've added them to until they are linked again.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-warning" id="confirmUnlinkBtn">Unlink</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let companionToDelete = null;
    let companionToUnlink = null;

    function deleteCompanion(companionId) {
      companionToDelete = companionId;
      const modal = new bootstrap.Modal(document.getElementById('deleteCompanionModal'));
      modal.show();
    }

    function unlinkCompanion(companionId) {
      companionToUnlink = companionId;
      const modal = new bootstrap.Modal(document.getElementById('unlinkCompanionModal'));
      modal.show();
    }

    async function toggleCompanionPermission(companionId, canBeAddedByOthers) {
      try {
        const response = await fetch(`/companions/${companionId}/permissions`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ canBeAddedByOthers })
        });

        if (!response.ok) {
          // Revert checkbox if request failed
          const checkbox = document.getElementById(`canBeAddedByOthers${companionId}`);
          checkbox.checked = !canBeAddedByOthers;
          alert('Failed to update companion permissions');
        }
      } catch (error) {
        console.error('Error updating companion permissions:', error);
        // Revert checkbox
        const checkbox = document.getElementById(`canBeAddedByOthers${companionId}`);
        checkbox.checked = !canBeAddedByOthers;
        alert('Failed to update companion permissions');
      }
    }

    // Handle delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (companionToDelete) {
        try {
          const response = await fetch(`/companions/${companionToDelete}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Failed to delete companion');
          }
        } catch (error) {
          console.error('Error deleting companion:', error);
          alert('Failed to delete companion');
        }
      }
    });

    // Handle unlink confirmation
    document.getElementById('confirmUnlinkBtn').addEventListener('click', async () => {
      if (companionToUnlink) {
        try {
          const response = await fetch(`/companions/${companionToUnlink}/unlink`, {
            method: 'PUT'
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Failed to unlink companion');
          }
        } catch (error) {
          console.error('Error unlinking companion:', error);
          alert('Failed to unlink companion');
        }
      }
    });
  </script>
</body>
</html>