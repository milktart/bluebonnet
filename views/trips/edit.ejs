<!-- Edit Trip Form - Sidebar Version -->
<div class="flex items-start justify-between mb-6">
  <div class="flex items-center">
    <button onclick="closeSecondarySidebar()" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    <h2 class="text-lg font-bold text-gray-900">Edit Trip</h2>
  </div>
  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
    <span class="material-symbols-outlined text-blue-600" style="font-size: 16px;">edit</span>
  </div>
</div>

<form action="/trips/<%= trip.id %>?_method=PUT" method="POST" class="space-y-4">
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Trip Name *</label>
    <input type="text" name="name" value="<%= trip.name %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
  </div>

  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Departure Date *</label>
      <input type="text" data-date-format="DD MMM YYYY" name="departureDate" value="<%= trip.departureDate %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Return Date *</label>
      <input type="text" data-date-format="DD MMM YYYY" name="returnDate" value="<%= trip.returnDate %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Trip Purpose *</label>
    <select name="purpose" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white" required>
      <option value="pleasure" <%= trip.purpose === 'pleasure' ? 'selected' : '' %>>Pleasure</option>
      <option value="business" <%= trip.purpose === 'business' ? 'selected' : '' %>>Business</option>
      <option value="other" <%= trip.purpose === 'other' ? 'selected' : '' %>>Other</option>
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Traveling Companions</label>
    <div class="companion-selector space-y-2">
      <div class="flex gap-2">
        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="companionSearch" placeholder="Search companions..." autocomplete="off">
        <button type="button" class="px-4 py-2 text-white text-sm font-medium rounded-md transition-colors focus:outline-none focus:ring-2" id="addCompanionBtn" style="background-color: <%= getApproveColor() %>; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
          Add
        </button>
      </div>
      <div id="companionDropdown" class="hidden max-h-48 p-1 bg-white border border-gray-200 rounded-lg shadow-lg overflow-y-auto z-10"></div>
      <div id="selectedCompanions" class="flex flex-wrap gap-2"></div>
      <input type="hidden" name="companions" id="companionsHidden">
    </div>
    <p class="text-xs text-gray-500 mt-2">Search for existing companions or type a name and click Add to create a new one</p>
  </div>

  <!-- Companion Permissions Section -->
  <div class="border-t border-gray-200 pt-4">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">Companion Permissions</h3>
    <div id="companionPermissions" class="space-y-2">
      <!-- Will be populated by JavaScript -->
    </div>
    <input type="hidden" name="companionPermissions" id="companionPermissionsJson" value="{}">
  </div>

  <div class="flex items-center">
    <input type="checkbox" id="defaultCompanionEditPermission" name="defaultCompanionEditPermission" <%= trip.defaultCompanionEditPermission ? 'checked' : '' %> class="w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    <label for="defaultCompanionEditPermission" class="ml-2 text-sm font-medium text-gray-700">
      Allow companions to edit trip items
    </label>
  </div>

  <div class="flex space-x-3 pt-4">
    <button type="submit" class="flex-1 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors" style="background-color: <%= getApproveColor() %>; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
      Update Trip
    </button>
    <button type="button" onclick="closeSecondarySidebar()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
      Cancel
    </button>
  </div>
</form>

<!-- Delete Trip Section -->
<form action="/trips/<%= trip.id %>?_method=DELETE" method="POST" class="mt-4 pt-4 border-t border-gray-200">
  <button type="submit" class="w-full text-white py-2 px-4 rounded-md transition-colors" style="background-color: <%= getDeclineColor() %>; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" onclick="return confirm('Are you sure you want to delete this trip? This action cannot be undone.')">
    Delete Trip
  </button>
</form>
<!-- Hidden data attributes to store companion information -->
<% if (trip.tripCompanions && trip.tripCompanions.length > 0) { %>
  <% trip.tripCompanions.forEach((tc) => { %>
    <input type="hidden" class="existing-companion-data" data-id="<%= tc.companion.id %>" data-name="<%= tc.companion.name.replace(/"/g, '&quot;') %>" data-email="<%= tc.companion.email %>" data-phone="<%= tc.companion.phone || '' %>" data-linked="<%= !!tc.companion.linkedAccount %>" data-own="<%= tc.companion.createdBy === user.id %>" data-can-add="<%= tc.canAddItems %>" data-permission="<%= tc.permissionSource %>">
  <% }); %>
<% } %>

<script>
  // Initialize companion search - self-contained implementation
  // Same pattern as create trip form in dashboard
  (function() {
    const searchInput = document.getElementById('companionSearch');
    const searchResults = document.getElementById('companionDropdown');
    const companionsContainer = document.getElementById('selectedCompanions');
    const companionsJson = document.getElementById('companionsHidden');
    const addBtn = document.getElementById('addCompanionBtn');

    let selectedCompanions = [];

    if (!searchInput) return;

    // Handle search input
    searchInput.addEventListener('input', async function(e) {
      const query = this.value.trim();

      if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
      }

      try {
        const response = await fetch(`/companions/api/search?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const companions = await response.json();
        const results = companions.filter(c => !selectedCompanions.find(sc => sc.id === c.id));

        if (results.length > 0) {
          searchResults.innerHTML = results.map(companion => `
            <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" data-companion-id="${companion.id}" data-companion-name="${companion.name}" data-companion-email="${companion.email}">
              <div class="font-medium text-gray-900">${companion.name}</div>
              <div class="text-xs text-gray-500">${companion.email}</div>
            </div>
          `).join('');
          searchResults.classList.remove('hidden');
        } else {
          searchResults.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No companions found</div>';
          searchResults.classList.remove('hidden');
        }
      } catch (error) {
        searchResults.innerHTML = '<div class="px-4 py-2 text-sm text-red-500">Error searching companions</div>';
        searchResults.classList.remove('hidden');
      }
    });

    // Handle clicking on a result
    document.addEventListener('click', function(e) {
      const resultItem = e.target.closest('[data-companion-id]');
      if (resultItem && searchResults.contains(resultItem)) {
        const companion = {
          id: resultItem.dataset.companionId,
          name: resultItem.dataset.companionName,
          email: resultItem.dataset.companionEmail,
          isLinked: false,
          isOwn: false
        };
        selectedCompanions.push(companion);

        // Add to display
        const companionEl = document.createElement('div');
        companionEl.className = 'inline-flex items-center gap-2 bg-blue-100 text-blue-900 px-3 py-2 rounded-lg text-sm mr-2 mb-2';
        companionEl.innerHTML = `
          <span>${companion.name}</span>
          <button type="button" class="text-blue-900 hover:text-blue-700 font-bold ml-1 focus:outline-none" style="font-size: 1.2em; line-height: 1;">
            ×
          </button>
        `;

        const removeBtn = companionEl.querySelector('button');
        removeBtn.addEventListener('click', (event) => {
          event.preventDefault();
          selectedCompanions = selectedCompanions.filter(c => c.id !== companion.id);
          companionEl.remove();
          companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
        });

        companionsContainer.appendChild(companionEl);
        companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));

        // Clear search
        searchInput.value = '';
        searchResults.classList.add('hidden');
      }
      // Close dropdown when clicking outside
      else if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    // Handle Add button click (for creating new companion)
    if (addBtn) {
      addBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (!query) {
          alert('Please enter a name');
          return;
        }

        // Show form to create new companion with name and email
        const email = prompt('Enter email for ' + query + ':');
        if (!email) return;

        try {
          const response = await fetch('/companions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: query, email: email })
          });

          if (response.ok) {
            const newCompanion = await response.json();
            selectedCompanions.push(newCompanion);

            const companionEl = document.createElement('div');
            companionEl.className = 'inline-flex items-center gap-2 bg-blue-100 text-blue-900 px-3 py-2 rounded-lg text-sm mr-2 mb-2';
            companionEl.innerHTML = `
              <span>${newCompanion.name}</span>
              <button type="button" class="text-blue-900 hover:text-blue-700 font-bold ml-1 focus:outline-none" style="font-size: 1.2em; line-height: 1;">
                ×
              </button>
            `;

            const removeBtn = companionEl.querySelector('button');
            removeBtn.addEventListener('click', (event) => {
              event.preventDefault();
              selectedCompanions = selectedCompanions.filter(c => c.id !== newCompanion.id);
              companionEl.remove();
              companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
            });

            companionsContainer.appendChild(companionEl);
            companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
            searchInput.value = '';
            searchResults.classList.add('hidden');
          }
        } catch (error) {
          alert('Error creating companion: ' + error.message);
        }
      });
    }
  })();

  // Initialize companion permissions after page loads
  function initializeCompanionPermissions() {
    // Build existingCompanions array from hidden data attributes
    const companionElements = document.querySelectorAll('.existing-companion-data');
    window.existingCompanions = Array.from(companionElements).map(el => ({
      id: el.dataset.id,
      name: el.dataset.name,
      email: el.dataset.email,
      phone: el.dataset.phone,
      isLinked: el.dataset.linked === 'true',
      isOwn: el.dataset.own === 'true',
      canAddItems: el.dataset.canAdd === 'true',
      permissionSource: el.dataset.permission
    }));

    updateCompanionPermissions();

    // Listen for changes to selected companions
    const companionContainer = document.getElementById('selectedCompanions');
    if (companionContainer) {
      const observer = new MutationObserver(updateCompanionPermissions);
      observer.observe(companionContainer, { childList: true });
    }
  }

  function updateCompanionPermissions() {
    const permissionsContainer = document.getElementById('companionPermissions');
    const companions = window.existingCompanions || [];

    if (companions.length === 0) {
      permissionsContainer.innerHTML = '<p class="text-xs text-gray-500">Add companions to configure permissions</p>';
      return;
    }

    permissionsContainer.innerHTML = companions.map(companion => {
      const isManageTravel = companion.permissionSource === 'manage_travel';
      const isOwner = companion.permissionSource === 'owner';
      const isDisabled = isManageTravel || isOwner;

      let permissionText = 'Trip companion';
      if (isOwner) {
        permissionText = 'Trip owner';
      } else if (isManageTravel) {
        permissionText = 'Has manage_travel permission';
      }

      return `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
          <div>
            <p class="text-sm font-medium text-gray-900">${companion.name}</p>
            <p class="text-xs text-gray-500">${permissionText}</p>
          </div>
          <label class="flex items-center">
            <input
              type="checkbox"
              class="companion-can-edit w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              data-companion-id="${companion.id}"
              ${companion.canAddItems && !isDisabled ? 'checked' : ''}
              ${isDisabled ? 'disabled' : ''}
              onchange="updateCompanionPermissionsJson()"
            >
            <span class="ml-2 text-sm text-gray-700">Can add items</span>
          </label>
        </div>
      `;
    }).join('');
  }

  function updateCompanionPermissionsJson() {
    const permissions = {};
    document.querySelectorAll('.companion-can-edit:not(:disabled)').forEach(checkbox => {
      permissions[checkbox.dataset.companionId] = checkbox.checked;
    });
    document.getElementById('companionPermissionsJson').value = JSON.stringify(permissions);
  }

  // Initialize when form loads
  initializeCompanionPermissions();
</script>