<!-- Edit Trip Form - Sidebar Version -->
<div class="flex items-start justify-between mb-6">
  <div class="flex items-center">
    <button onclick="closeSecondarySidebar()" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    <h2 class="text-lg font-bold text-gray-900">Edit Trip</h2>
  </div>
  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
    <span class="material-symbols-outlined text-blue-600" style="font-size: 16px;">edit</span>
  </div>
</div>

<form action="/trips/<%= trip.id %>?_method=PUT" method="POST" class="space-y-4">
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Trip Name *</label>
    <input type="text" name="name" value="<%= trip.name %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
  </div>

  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Departure Date *</label>
      <input type="text" data-date-format="DD MMM YYYY" name="departureDate" value="<%= trip.departureDate %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Return Date *</label>
      <input type="text" data-date-format="DD MMM YYYY" name="returnDate" value="<%= trip.returnDate %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Trip Purpose *</label>
    <select name="purpose" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white" required>
      <option value="pleasure" <%= trip.purpose === 'pleasure' ? 'selected' : '' %>>Pleasure</option>
      <option value="business" <%= trip.purpose === 'business' ? 'selected' : '' %>>Business</option>
      <option value="other" <%= trip.purpose === 'other' ? 'selected' : '' %>>Other</option>
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Traveling Companions</label>
    <div class="companion-selector space-y-2">
      <div class="flex gap-2">
        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="companionSearch" placeholder="Search companions..." autocomplete="off">
        <button type="button" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" id="addCompanionBtn">
          Add
        </button>
      </div>
      <div id="companionDropdown" class="hidden max-h-48 p-1 bg-white border border-gray-200 rounded-lg shadow-lg overflow-y-auto z-10"></div>
      <div id="selectedCompanions" class="flex flex-wrap gap-2"></div>
      <input type="hidden" name="companions" id="companionsHidden">
    </div>
    <p class="text-xs text-gray-500 mt-2">Search for existing companions or type a name and click Add to create a new one</p>
  </div>

  <!-- Companion Permissions Section -->
  <div class="border-t border-gray-200 pt-4">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">Companion Permissions</h3>
    <div id="companionPermissions" class="space-y-2">
      <!-- Will be populated by JavaScript -->
    </div>
    <input type="hidden" name="companionPermissions" id="companionPermissionsJson" value="{}">
  </div>

  <div class="flex items-center">
    <input type="checkbox" id="defaultCompanionEditPermission" name="defaultCompanionEditPermission" <%= trip.defaultCompanionEditPermission ? 'checked' : '' %> class="w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    <label for="defaultCompanionEditPermission" class="ml-2 text-sm font-medium text-gray-700">
      Allow companions to edit trip items
    </label>
  </div>

  <div class="flex space-x-3 pt-4">
    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
      Update Trip
    </button>
    <button type="button" onclick="closeSecondarySidebar()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
      Cancel
    </button>
  </div>
</form>

<!-- Delete Trip Section -->
<form action="/trips/<%= trip.id %>?_method=DELETE" method="POST" class="mt-4 pt-4 border-t border-gray-200">
  <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors" onclick="return confirm('Are you sure you want to delete this trip? This action cannot be undone.')">
    Delete Trip
  </button>
</form>
<script>
  // Pass existing companions data to JavaScript
  window.existingCompanions = [
    <% if (trip.tripCompanions && trip.tripCompanions.length > 0) { %>
      <% trip.tripCompanions.forEach((tc, index) => { %>
        {
          id: '<%= tc.companion.id %>',
          name: '<%= tc.companion.name.replace(/'/g, "\\'") %>',
          email: '<%= tc.companion.email %>',
          phone: '<%= tc.companion.phone || "" %>',
          isLinked: <%= !!tc.companion.linkedAccount %>,
          isOwn: <%= tc.companion.createdBy === user.id %>,
          linkedAccountName: <%= tc.companion.linkedAccount ? `'${tc.companion.linkedAccount.firstName} ${tc.companion.linkedAccount.lastName}'` : 'null' %>,
          canAddItems: <%= tc.canAddItems %>,
          permissionSource: '<%= tc.permissionSource %>'
        }<%= index < trip.tripCompanions.length - 1 ? ',' : '' %>
      <% }); %>
    <% } %>
  ];

  // Render companion permissions on page load
  document.addEventListener('DOMContentLoaded', () => {
    updateCompanionPermissions();

    // Listen for changes to selected companions
    const companionContainer = document.getElementById('selectedCompanions');
    const observer = new MutationObserver(updateCompanionPermissions);
    observer.observe(companionContainer, { childList: true });
  });

  function updateCompanionPermissions() {
    const permissionsContainer = document.getElementById('companionPermissions');
    const companions = window.existingCompanions || [];

    if (companions.length === 0) {
      permissionsContainer.innerHTML = '<p class="text-xs text-gray-500">Add companions to configure permissions</p>';
      return;
    }

    permissionsContainer.innerHTML = companions.map(companion => {
      const isManageTravel = companion.permissionSource === 'manage_travel';
      const isOwner = companion.permissionSource === 'owner';
      const isDisabled = isManageTravel || isOwner;

      let permissionText = 'Trip companion';
      if (isOwner) {
        permissionText = 'Trip owner';
      } else if (isManageTravel) {
        permissionText = 'Has manage_travel permission';
      }

      return `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
          <div>
            <p class="text-sm font-medium text-gray-900">${companion.name}</p>
            <p class="text-xs text-gray-500">${permissionText}</p>
          </div>
          <label class="flex items-center">
            <input
              type="checkbox"
              class="companion-can-edit w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              data-companion-id="${companion.id}"
              ${companion.canAddItems && !isDisabled ? 'checked' : ''}
              ${isDisabled ? 'disabled' : ''}
              onchange="updateCompanionPermissionsJson()"
            >
            <span class="ml-2 text-sm text-gray-700">Can add items</span>
          </label>
        </div>
      `;
    }).join('');
  }

  function updateCompanionPermissionsJson() {
    const permissions = {};
    document.querySelectorAll('.companion-can-edit:not(:disabled)').forEach(checkbox => {
      permissions[checkbox.dataset.companionId] = checkbox.checked;
    });
    document.getElementById('companionPermissionsJson').value = JSON.stringify(permissions);
  }
</script>