<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%- title %></title>
  <!-- Core Application CSS -->
  <link rel="stylesheet" href="/css/core.css">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Google Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <!-- Tailwind CSS -->
  <link href="https://unpkg.com/tailwindcss@^2.0/dist/tailwind.min.css" rel="stylesheet">
  <!-- Trips Styles -->
  <link href="/css/trips.css" rel="stylesheet">
  <!-- Socket.IO Client Library -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body class="overflow-hidden" data-current-user-id="<%- user.id %>" data-current-user-name="<%- user.firstName %> <%- user.lastName %>">
  <!-- Full-screen map -->
  <div id="tripMap"></div>

  <!-- Primary Sidebar -->
  <div class="primary-sidebar sidebar">
    <!-- Fixed Header -->
    <div class="sidebar-header p-6">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
          <a href="/" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </a>
          <%
            // formatDate is now available via res.locals from utils/dateFormatter.js

            // Determine icon based on trip purpose
            let tripIcon = 'flights_and_hotels'; // default
            let iconClass = 'text-blue-600';
            let bgClass = 'bg-blue-100';

            if (trip.purpose === 'business') {
              tripIcon = 'badge';
              iconClass = 'text-purple-600';
              bgClass = 'bg-purple-100';
            } else if (trip.purpose === 'leisure' || trip.purpose === 'family' || trip.purpose === 'romantic') {
              tripIcon = 'hotel';
              iconClass = 'text-green-600';
              bgClass = 'bg-green-100';
            }
          %>
          <div class="w-8 h-8 <%= bgClass %> rounded-lg flex items-center justify-center mr-3 ml-0 mr-1">
            <span class="material-symbols-outlined <%= iconClass %>" style="font-size: 16px;"><%= tripIcon %></span>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-900"><%- trip.name %></h1>
            <p class="text-xs text-gray-500"><%- formatDate(trip.departureDate) %> - <%- formatDate(trip.returnDate) %></p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <% if (isOwner) { %>
            <button data-action="loadSidebarContent" data-url="/trips/<%- trip.id %>/edit/sidebar" class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md shadow-sm hover:bg-blue-100">
              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Edit
            </button>
          <% } %>
        </div>
      </div>

      <!-- Flash messages -->
      <% if (typeof success_msg !== 'undefined' && success_msg && success_msg.length > 0) { %>
        <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-md text-green-800 text-sm">
          <%= success_msg %>
        </div>
      <% } %>
      <% if (typeof error_msg !== 'undefined' && error_msg && error_msg.length > 0) { %>
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-800 text-sm">
          <%= error_msg %>
        </div>
      <% } %>
      <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-800 text-sm">
          <%= error %>
        </div>
      <% } %>

      <!-- Add buttons for new items -->
      <div class="mb-6">
        <button data-action="showAddItemMenu" class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Item
        </button>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="sidebar-content">
      <%- include('../partials/trip-sidebar-content') %>
    </div>
  </div>

  <!-- Secondary Sidebar - for editing forms -->
  <div id="secondary-sidebar" class="secondary-sidebar sidebar">
    <div class="p-6">
      <div id="secondary-sidebar-content">
        <!-- Dynamic edit content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Tertiary Sidebar - for editing forms -->
  <div id="tertiary-sidebar" class="tertiary-sidebar sidebar">
    <div class="p-6">
      <div id="tertiary-sidebar-content">
        <!-- Dynamic edit content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- External dependencies (CDN) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Bundled JavaScript (with code splitting and minification) -->
  <script type="module" src="<%= getBundle('common') %>"></script>
  <script type="module" src="<%= getBundle('trip-view') %>"></script>

  <script>
    // Map configuration
    window.MAP_TILE_URL = '<%- mapTileUrl %>';

    // Trip data for map
    // Make trip ID available globally for sidebar form loading
    window.tripId = '<%- trip.id %>';
    window.userId = '<%- user.id %>';
    window.userName = '<%- user.firstName %> <%- user.lastName %>';

    // Also define as local for backward compatibility
    const tripId = window.tripId;
    const userId = window.userId;
    const userName = window.userName;

    const tripData = {
      id: tripId,
      departureDate: '<%- trip.departureDate %>',
      returnDate: '<%- trip.returnDate %>',
      flights: <%- JSON.stringify(trip.flights) %>,
      hotels: <%- JSON.stringify(trip.hotels) %>,
      transportation: <%- JSON.stringify(trip.transportation) %>,
      carRentals: <%- JSON.stringify(trip.carRentals) %>,
      events: <%- JSON.stringify(trip.events) %>
    };

    // Airline data for flight lookup
    const airlineData = <%- JSON.stringify(airlines) %>;

    // Initialize map and hover effects
    let mapInitialized = false;
    let currentMap = null;
    const activeAnimations = {};


    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', async function() {
      if (typeof L === 'undefined') {
        const mapEl = document.getElementById('tripMap');
        if (mapEl) {
          mapEl.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-4 text-red-700">Map library not loaded. Please refresh the page.</div>';
        }
        return;
      }

      // Wait for maps module to load (loaded lazily by trip-view bundle)
      let attempts = 0;
      const maxAttempts = 20; // 2 seconds max wait

      while (typeof initOverviewMap === 'undefined' && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (typeof initOverviewMap === 'undefined') {
        const mapEl = document.getElementById('tripMap');
        if (mapEl) {
          mapEl.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-4 text-red-700">Maps module not loaded. Please refresh the page.</div>';
        }
        return;
      }

      // Initialize map
      if (!mapInitialized) {
        initOverviewMap(tripData, 'tripMap')
          .then((map) => {
            mapInitialized = true;
            currentMap = map;
            setupTimelineHoverEffects(map);

            // Map sizing is now handled by maps.js
          })
          .catch(error => {
            const mapEl = document.getElementById('tripMap');
            if (mapEl) {
              mapEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 text-yellow-700">Map failed to load: ' + error.message + '</div>';
            }
          });
      }
    });

    // Color configuration - from config/itemColors.js
    const itemColors = {
      flight: '<%= getItemHexColor("flight") %>',
      hotel: '<%= getItemHexColor("hotel") %>',
      transportation: '<%= getItemHexColor("transportation") %>',
      carRental: '<%= getItemHexColor("carRental") %>',
      event: '<%= getItemHexColor("event") %>'
    };

    // Show add item menu
    function showAddItemMenu() {
      const container = document.getElementById('secondary-sidebar-content');
      const content = `
        <div class="flex items-start justify-between mb-6">
          <div class="flex items-center">
            <button data-action="closeSecondarySidebar" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <h2 class="text-lg font-bold text-gray-900">Add Item</h2>
          </div>

          <div class="flex items-center">
            <div class="mx-1 w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style="background-color: ${itemColors.flight}22;">
              <span class="material-symbols-outlined" style="font-size: 16px; color: ${itemColors.flight};">flight</span>
            </div>
            <div class="mx-1 w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style="background-color: ${itemColors.hotel}22;">
              <span class="material-symbols-outlined" style="font-size: 16px; color: ${itemColors.hotel};">hotel</span>
            </div>
            <div class="mx-1 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.transportation}22;">
              <span class="material-symbols-outlined" style="font-size: 16px; color: ${itemColors.transportation};">train</span>
            </div>
            <div class="mx-1 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.carRental}22;">
              <span class="material-symbols-outlined" style="font-size: 16px; color: ${itemColors.carRental};">directions_car</span>
            </div>
            <div class="mx-1 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.event}22;">
              <span class="material-symbols-outlined" style="font-size: 16px; color: ${itemColors.event};">event</span>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <button data-action="showAddForm" data-form-type="flight" class="w-full flex items-center space-x-3 p-4 rounded-lg border border-gray-200 bg-white shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-colors">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.flight}22;">
              <span class="material-symbols-outlined" style="color: ${itemColors.flight}; font-size: 16px;">flight</span>
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-sm font-medium text-gray-900">Add Flight</h3>
              <p class="text-xs text-gray-500">Add a flight to your trip</p>
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>

          <button data-action="showAddForm" data-form-type="hotel" class="w-full flex items-center space-x-3 p-4 rounded-lg border border-gray-200 bg-white shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-colors">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.hotel}22;">
              <span class="material-symbols-outlined" style="color: ${itemColors.hotel}; font-size: 16px;">hotel</span>
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-sm font-medium text-gray-900">Add Hotel</h3>
              <p class="text-xs text-gray-500">Add accommodation to your trip</p>
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>

          <button data-action="showAddForm" data-form-type="transportation" class="w-full flex items-center space-x-3 p-4 rounded-lg border border-gray-200 bg-white shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-colors">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.transportation}22;">
              <span class="material-symbols-outlined" style="color: ${itemColors.transportation}; font-size: 16px;">train</span>
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-sm font-medium text-gray-900">Add Transportation</h3>
              <p class="text-xs text-gray-500">Add train, bus, or other transport</p>
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>

          <button data-action="showAddForm" data-form-type="carRental" class="w-full flex items-center space-x-3 p-4 rounded-lg border border-gray-200 bg-white shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-colors">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.carRental}22;">
              <span class="material-symbols-outlined" style="color: ${itemColors.carRental}; font-size: 16px;">directions_car</span>
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-sm font-medium text-gray-900">Add Car Rental</h3>
              <p class="text-xs text-gray-500">Add rental car details</p>
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>

          <button data-action="showAddForm" data-form-type="event" class="w-full flex items-center space-x-3 p-4 rounded-lg border border-gray-200 bg-white shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-colors">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${itemColors.event}22;">
              <span class="material-symbols-outlined" style="color: ${itemColors.event}; font-size: 16px;">event</span>
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-sm font-medium text-gray-900">Add Event</h3>
              <p class="text-xs text-gray-500">Add activity or event</p>
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      `;

      if (container) container.innerHTML = content;
      openSecondarySidebar();
    }

    // Toggle event time fields visibility
    function toggleEventTimesVisibility(formType, isAllDay) {
      const timeFields = document.querySelectorAll(`.event-time-field-${formType}`);
      timeFields.forEach(field => {
        field.style.display = isAllDay ? 'none' : 'block';
      });
    }

    // Helper function to combine date and time inputs into ISO datetime string
    document.addEventListener('submit', function(e) {
      if (e.target.tagName === 'FORM') {
        const form = e.target;

        // Check if this is an all-day event
        const allDayCheckbox = form.querySelector('[id$="AllDay"]');
        const isAllDayEvent = allDayCheckbox && allDayCheckbox.checked;

        // Handle various datetime field combinations
        const dateTimeFields = [
          {date: 'departureDate', time: 'departureTime', combined: 'departureDateTime'},
          {date: 'arrivalDate', time: 'arrivalTime', combined: 'arrivalDateTime'},
          {date: 'checkInDate', time: 'checkInTime', combined: 'checkInDateTime'},
          {date: 'checkOutDate', time: 'checkOutTime', combined: 'checkOutDateTime'},
          {date: 'pickupDate', time: 'pickupTime', combined: 'pickupDateTime'},
          {date: 'dropoffDate', time: 'dropoffTime', combined: 'dropoffDateTime'},
          {date: 'startDate', time: 'startTime', combined: 'startDateTime'},
          {date: 'endDate', time: 'endTime', combined: 'endDateTime'}
        ];

        dateTimeFields.forEach(field => {
          const dateInput = form.querySelector(`[name="${field.date}"]`);
          const timeInput = form.querySelector(`[name="${field.time}"]`);

          if (dateInput && timeInput && dateInput.value) {
            // Remove any existing hidden input with this name to prevent duplicates
            const existingHidden = form.querySelector(`input[type="hidden"][name="${field.combined}"]`);
            if (existingHidden) {
              existingHidden.remove();
            }

            // For all-day events, only use the date (set time to midnight)
            if (isAllDayEvent && (field.combined === 'startDateTime' || field.combined === 'endDateTime')) {
              // Create hidden input for combined datetime with midnight time
              const hiddenInput = document.createElement('input');
              hiddenInput.type = 'hidden';
              hiddenInput.name = field.combined;
              hiddenInput.value = `${dateInput.value}T00:00:00.000Z`;
              form.appendChild(hiddenInput);
            } else if (!isAllDayEvent && timeInput.value) {
              // Regular datetime with time specified
              const hiddenInput = document.createElement('input');
              hiddenInput.type = 'hidden';
              hiddenInput.name = field.combined;
              hiddenInput.value = `${dateInput.value}T${timeInput.value}:00.000Z`;
              form.appendChild(hiddenInput);
            }
          }
        });
      }
    });

    // Flight date initialization and auto-update functions
    function initializeFlightDates(tripStartDate) {
      // Set departure and arrival dates to trip start date after form is rendered
      setTimeout(() => {
        const departureInput = document.getElementById('flightDepartureDate');
        const arrivalInput = document.getElementById('flightArrivalDate');

        if (departureInput && arrivalInput && !departureInput.value) {
          departureInput.value = tripStartDate;
          arrivalInput.value = tripStartDate;
        }
      }, 100);
    }

    function updateFlightArrivalDate() {
      const departureInput = document.getElementById('flightDepartureDate');
      const arrivalInput = document.getElementById('flightArrivalDate');

      if (departureInput && arrivalInput && departureInput.value) {
        // Update arrival date to match departure date
        arrivalInput.value = departureInput.value;
      }
    }

    function updateEditFlightArrivalDate() {
      const departureInput = document.getElementById('editFlightDepartureDate');
      const arrivalInput = document.getElementById('editFlightArrivalDate');

      if (departureInput && arrivalInput && departureInput.value) {
        // Update arrival date to match departure date
        arrivalInput.value = departureInput.value;
      }
    }

    // Hotel date auto-update functions
    function updateHotelCheckOutDate() {
      const checkInInput = document.getElementById('hotelCheckInDate');
      const checkOutInput = document.getElementById('hotelCheckOutDate');

      if (checkInInput && checkOutInput && checkInInput.value) {
        // Calculate checkout date as one day after check-in
        const checkInDate = new Date(checkInInput.value);
        checkInDate.setDate(checkInDate.getDate() + 1);

        // Format as YYYY-MM-DD for the date input
        const year = checkInDate.getFullYear();
        const month = String(checkInDate.getMonth() + 1).padStart(2, '0');
        const day = String(checkInDate.getDate()).padStart(2, '0');
        checkOutInput.value = `${year}-${month}-${day}`;
      }
    }

    function updateEditHotelCheckOutDate() {
      const checkInInput = document.getElementById('editHotelCheckInDate');
      const checkOutInput = document.getElementById('editHotelCheckOutDate');

      if (checkInInput && checkOutInput && checkInInput.value) {
        // Calculate checkout date as one day after check-in
        const checkInDate = new Date(checkInInput.value);
        checkInDate.setDate(checkInDate.getDate() + 1);

        // Format as YYYY-MM-DD for the date input
        const year = checkInDate.getFullYear();
        const month = String(checkInDate.getMonth() + 1).padStart(2, '0');
        const day = String(checkInDate.getDate()).padStart(2, '0');
        checkOutInput.value = `${year}-${month}-${day}`;
      }
    }

    // Car rental date auto-update functions
    function updateRentalDropoffDate() {
      const pickupInput = document.getElementById('rentalPickupDate');
      const dropoffInput = document.getElementById('rentalDropoffDate');

      if (pickupInput && dropoffInput && pickupInput.value) {
        // Calculate dropoff date as one day after pickup
        const pickupDate = new Date(pickupInput.value);
        pickupDate.setDate(pickupDate.getDate() + 1);

        // Format as YYYY-MM-DD for the date input
        const year = pickupDate.getFullYear();
        const month = String(pickupDate.getMonth() + 1).padStart(2, '0');
        const day = String(pickupDate.getDate()).padStart(2, '0');
        dropoffInput.value = `${year}-${month}-${day}`;
      }
    }

    function updateAddRentalDropoffDate() {
      const pickupInput = document.getElementById('addRentalPickupDate');
      const dropoffInput = document.getElementById('addRentalDropoffDate');

      if (pickupInput && dropoffInput && pickupInput.value) {
        // Calculate dropoff date as one day after pickup
        const pickupDate = new Date(pickupInput.value);
        pickupDate.setDate(pickupDate.getDate() + 1);

        // Format as YYYY-MM-DD for the date input
        const year = pickupDate.getFullYear();
        const month = String(pickupDate.getMonth() + 1).padStart(2, '0');
        const day = String(pickupDate.getDate()).padStart(2, '0');
        dropoffInput.value = `${year}-${month}-${day}`;
      }
    }

    // NOTE: showAddForm is now defined in trip-view-sidebar.js
    // This function has been moved there to handle AJAX form loading

    // Trip invitation response handler
    async function respondToTripInvitation(tripId, response) {
      try {
        // First, find the invitation ID for this trip
        const pendingRes = await fetch('/trip-invitations/pending');
        const pendingData = await pendingRes.json();

        const invitation = pendingData.invitations && pendingData.invitations.find(inv => inv.tripId === tripId);
        if (!invitation) {
          return;
        }

        // Respond to the invitation
        const respondRes = await fetch(`/trip-invitations/${invitation.id}/respond`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ response })
        });

        if (respondRes.ok) {
          // Silently reload the page
          setTimeout(() => location.reload(), 300);
        }
      } catch (error) {
        // Silently handle invitation response errors
      }
    }


  </script>

</body>
</html>
