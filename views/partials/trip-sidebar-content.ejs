<!-- Trip Timeline Content - Used for both initial load and async refresh -->
<div class="pt-6 pr-6 pb-6 pl-2">
  <!-- Pending Trip Invitations Section -->
  <% if (typeof pendingInvitations !== 'undefined' && pendingInvitations && pendingInvitations.length > 0) { %>
    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <h3 class="text-sm font-semibold text-blue-900 mb-3">
        <i class="bi bi-info-circle-fill me-2"></i>Pending Invitation
      </h3>
      <p class="text-sm text-blue-800 mb-3">
        You've been invited to join this trip. Accept or decline below.
      </p>
      <div class="flex gap-2">
        <button
          type="button"
          class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors"
          onclick="respondToTripInvitation('<%= trip.id %>', 'join')"
        >
          <i class="bi bi-check-lg me-1"></i>Join Trip
        </button>
        <button
          type="button"
          class="flex-1 px-3 py-2 bg-white text-red-600 border border-red-200 text-sm font-medium rounded-md hover:bg-red-50 transition-colors"
          onclick="respondToTripInvitation('<%= trip.id %>', 'decline')"
        >
          <i class="bi bi-x-lg me-1"></i>Decline
        </button>
      </div>
    </div>
  <% } %>

  <%
    // All helper functions now available via res.locals from utils/dateFormatter.js
    // Available: formatDate, getFlightNum, getCityName, getAirportCode,
    //            calculateLayoverDuration, getLayoverText
    const allItems = [];

    // Helper function to check if a hotel exists during the layover period
    function hasHotelDuringPeriod(startDateTime, endDateTime, hotels) {
      return hotels.some(h => {
        const hotelCheckIn = new Date(h.checkInDateTime);
        const hotelCheckOut = new Date(h.checkOutDateTime);
        // Check if hotel overlaps with the layover period
        return hotelCheckIn <= endDateTime && hotelCheckOut >= startDateTime;
      });
    }

    // Helper function to get timezone for an item
    function getItemTimezone(item) {
      if (item.type === 'flight' && item.data.originTimezone) {
        return item.data.originTimezone;
      } else if (item.type === 'hotel' && item.data.timezone) {
        return item.data.timezone;
      } else if (item.type === 'transportation' && item.data.originTimezone) {
        return item.data.originTimezone;
      } else if (item.type === 'carRental' && item.data.pickupTimezone) {
        return item.data.pickupTimezone;
      } else if (item.type === 'event' && item.data.timezone) {
        return item.data.timezone;
      }
      return null;
    }

    // Collect all items
    trip.flights.forEach(f => {
      const flightNum = getFlightNum(f.flightNumber);
      const airlineCode = f.flightNumber.replace(/\d+$/, '');
      const originCity = getCityName(f.origin);
      const destinationCity = getCityName(f.destination);
      allItems.push({
        type: 'flight',
        time: new Date(f.departureDateTime),
        timezone: f.originTimezone,
        data: f,
        display: `${airlineCode}${flightNum}: ${originCity} → ${destinationCity}`,
        hasSegment: true,
        marker: null,
        id: f.id
      });
    });

    trip.hotels.forEach(h => {
      allItems.push({
        type: 'hotel',
        time: new Date(h.checkInDateTime),
        timezone: h.timezone,
        data: h,
        display: h.hotelName,
        hasSegment: false,
        marker: null,
        id: h.id
      });
    });

    trip.transportation.forEach(t => {
      const originCity = getCityName(t.origin);
      const destinationCity = getCityName(t.destination);
      const transportationIcon =
        (t.method == "train") ? "train" :
        (t.method == "bus") ? "directions_bus" :
        (t.method == "ferry") ? "directions_boat" :
        (t.method == "shuttle") ? "airport_shuttle" :
        (t.method == "taxi/rideshare") ? "hail" :
        (t.method == "subway/metro") ? "directions_subway" :
        (t.method == "tram") ? "tram" :
        (t.method == "funicular") ? "funicular" :
        (t.method == "gondola") ? "gondola_lift" :
        (t.method == "monorail") ? "monorail" :
        (t.method == "other") ? "directions_boat" : "transportation";

      allItems.push({
        type: 'transportation',
        time: new Date(t.departureDateTime),
        timezone: t.originTimezone,
        data: t,
        display: `${originCity} → ${destinationCity}`,
        hasSegment: true,
        marker: null,
        icon: transportationIcon,
        id: t.id
      });
    });

    trip.carRentals.forEach(c => {
      allItems.push({
        type: 'carRental',
        time: new Date(c.pickupDateTime),
        timezone: c.pickupTimezone,
        data: c,
        display: `${c.company}`,
        hasSegment: false,
        marker: null,
        id: c.id
      });
    });

    trip.events.forEach(e => {
      allItems.push({
        type: 'event',
        time: new Date(e.startDateTime),
        timezone: e.timezone,
        data: e,
        display: e.name,
        hasSegment: false,
        marker: null,
        id: e.id
      });
    });

    // Sort by UTC time (all times are stored in UTC)
    allItems.sort((a, b) => a.time - b.time);

    // Assign markers - either use global assignments (from dashboard) or create local ones
    if (typeof globalMarkerAssignments !== 'undefined' && globalMarkerAssignments && Object.keys(globalMarkerAssignments).length > 0) {
      // Use global marker assignments passed from dashboard
      allItems.forEach(item => {
        const key = `${item.type}-${item.id}`;
        if (globalMarkerAssignments[key]) {
          item.marker = parseInt(globalMarkerAssignments[key]);
        }
      });
    } else {
      // Fallback: assign markers locally (for standalone sidebar rendering)
      let mapMarkerCounter = 0;
      allItems.forEach(item => {
        if (item.hasSegment) {
          mapMarkerCounter++;
          item.marker = mapMarkerCounter;
        }
      });
    }

    // Pre-calculate layovers for all consecutive flights
    const layoversByFlightId = {};
    const layoversByDateKey = {};

    for (let i = 0; i < allItems.length - 1; i++) {
      if (allItems[i].type === 'flight' && allItems[i + 1].type === 'flight') {
        const currentFlight = allItems[i];
        const nextFlight = allItems[i + 1];

        // Check if user is a participant on BOTH consecutive flights
        const currentFlightKey = `flight_${currentFlight.id}`;
        const nextFlightKey = `flight_${nextFlight.id}`;
        const userOnCurrentFlight = (typeof userItemCompanions !== 'undefined' && userItemCompanions && userItemCompanions[currentFlightKey]) === true;
        const userOnNextFlight = (typeof userItemCompanions !== 'undefined' && userItemCompanions && userItemCompanions[nextFlightKey]) === true;
        // For trip owners and invited companions, always show layovers
        // (they can see all items, not just ones they're explicitly added to)
        const userTravelingBothFlights = isOwner || (userOnCurrentFlight && userOnNextFlight);

        const layoverDuration = calculateLayoverDuration(currentFlight.data.arrivalDateTime, nextFlight.data.departureDateTime);

        if (layoverDuration) {
          // Layover < 24 hours - show for trip owners and companions traveling both flights
          if (userTravelingBothFlights) {
            const layoverInfo = {
              type: 'short',
              duration: layoverDuration,
              airport: getAirportCode(currentFlight.data.destination),
              text: getLayoverText(layoverDuration, getAirportCode(currentFlight.data.destination))
            };

            // Get departure dates to check if they're on different days
            let currentFlightDateKey, nextFlightDateKey;
            let timezone = currentFlight.data.originTimezone;
            if (timezone) {
              currentFlightDateKey = formatInTimezone(currentFlight.time, timezone, 'YYYY-MM-DD');
            } else {
              currentFlightDateKey = currentFlight.time.toISOString().split('T')[0];
            }

            timezone = nextFlight.data.originTimezone;
            if (timezone) {
              nextFlightDateKey = formatInTimezone(nextFlight.time, timezone, 'YYYY-MM-DD');
            } else {
              nextFlightDateKey = nextFlight.time.toISOString().split('T')[0];
            }

            // If on different dates, store with next flight's date; otherwise store with current flight
            if (currentFlightDateKey !== nextFlightDateKey) {
              layoversByDateKey[nextFlightDateKey] = layoverInfo;
            } else {
              layoversByFlightId[currentFlight.id] = layoverInfo;
            }
          }
        } else {
          // Layover >= 24 hours - check if accommodation exists for trip owners and companions
          if (userTravelingBothFlights) {
            const layoverStart = new Date(currentFlight.data.arrivalDateTime);
            const layoverEnd = new Date(nextFlight.data.departureDateTime);
            const hasHotel = hasHotelDuringPeriod(layoverStart, layoverEnd, trip.hotels);

            if (!hasHotel) {
              layoversByFlightId[currentFlight.id] = {
                type: 'long',
                city: getCityName(currentFlight.data.destination),
                arrivalDateTime: currentFlight.data.arrivalDateTime,
                departureDateTime: nextFlight.data.departureDateTime,
                destinationTimezone: currentFlight.data.destinationTimezone
              };
            }
          }
        }
      }
    }

    // Group items by local date while preserving the global chronological sort order
    const itemsByDate = {};
    const dateKeysInOrder = [];

    allItems.forEach(item => {
      // Get timezone for this item to convert date to local timezone
      let timezone = null;
      if (item.type === 'flight' && item.data.originTimezone) {
        timezone = item.data.originTimezone;
      } else if (item.type === 'hotel' && item.data.timezone) {
        timezone = item.data.timezone;
      } else if (item.type === 'transportation' && item.data.originTimezone) {
        timezone = item.data.originTimezone;
      } else if (item.type === 'carRental' && item.data.pickupTimezone) {
        timezone = item.data.pickupTimezone;
      } else if (item.type === 'event' && item.data.timezone) {
        timezone = item.data.timezone;
      }

      // Format date in local timezone for grouping
      let dateKey;
      if (timezone) {
        const dateStr = formatInTimezone(item.time, timezone, 'YYYY-MM-DD');
        dateKey = dateStr;
      } else {
        // Fallback to UTC if no timezone
        dateKey = item.time.toISOString().split('T')[0];
      }

      if (!itemsByDate[dateKey]) {
        itemsByDate[dateKey] = [];
        dateKeysInOrder.push(dateKey);
      }
      itemsByDate[dateKey].push(item);
    });
  %>

  <% if (allItems.length === 0) { %>
    <div class="text-center py-12">
      <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No items yet</h3>
      <p class="text-gray-500 mb-6">Add flights, hotels, or activities to see them here</p>
      <button onclick="showAddItemMenu()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Add first item
      </button>
    </div>
  <% } else { %>
    <div class="space-y-4">
      <% dateKeysInOrder.forEach(dateKey => {
        // Parse dateKey back to Date for display
        const [year, month, day] = dateKey.split('-');
        const displayDate = new Date(year, parseInt(month) - 1, day);
      %>
        <div class="border-l-2 border-blue-200 pl-4 ml-2">
          <div class="mb-3 flex items-center justify-between">
            <div class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
              <%- formatDate(displayDate) %>
            </div>
            <%
              const layoverForDate = layoversByDateKey[dateKey];
              if (layoverForDate && layoverForDate.type === 'short') {
            %>
              <div class="text-xs text-gray-500 font-medium layover-duration" style="border: none; padding: 0; margin: 0;">
                <%= layoverForDate.text %>
              </div>
            <%
              }
            %>
          </div>
          <div class="space-y-2">
            <%
              const dateItems = itemsByDate[dateKey];
              // Items are already in chronological order from the global sort
              dateItems.forEach((item, itemIndex) => {
              // Get timezone for this item based on its type
              let timezone = null;
              if (item.type === 'flight' && item.data.originTimezone) {
                timezone = item.data.originTimezone;
              } else if (item.type === 'hotel' && item.data.timezone) {
                timezone = item.data.timezone;
              } else if (item.type === 'transportation' && item.data.originTimezone) {
                timezone = item.data.originTimezone;
              } else if (item.type === 'carRental' && item.data.pickupTimezone) {
                timezone = item.data.pickupTimezone;
              } else if (item.type === 'event' && item.data.timezone) {
                timezone = item.data.timezone;
              }

              // Format time in the appropriate timezone
              const timeStr = formatInTimezone(item.data.departureDateTime || item.data.checkInDateTime || item.data.pickupDateTime || item.data.startDateTime, timezone, 'HH:mm');
              const [hours, minutes] = timeStr.split(':');
              const typeClass = `marker-${item.type}`;

              // Check if user is a participant in this item
              // Convert item type to match database enum (carRental -> car_rental)
              const itemTypeForDb = item.type === 'carRental' ? 'car_rental' : item.type;
              const itemKey = `${itemTypeForDb}_${item.id}`;
              const userIsParticipant = (typeof userItemCompanions !== 'undefined' && userItemCompanions && userItemCompanions[itemKey]) === true;
              // Non-participant style applies if user is not in the ItemCompanion list
              // This applies to anyone (owner or companion) who isn't explicitly added to the item
              const isNonParticipant = !userIsParticipant;
              const nonParticipantTitle = isNonParticipant ? 'You are not a participant in this item' : '';

              // Check if item is complete (in the past) - applies to flights, hotels, transportation, car rentals, and events during active trips
              let isComplete = false;
              let completeClass = '';
              let backgroundColor = 'bg-white';
              let nonParticipantClass = '';

              if (typeof tripStatus !== 'undefined' && tripStatus === 'in_progress') {
                let itemDateTime = null;

                // Determine which end time to use for completion check
                if (item.type === 'flight') {
                  itemDateTime = new Date(item.data.arrivalDateTime);
                } else if (item.type === 'hotel') {
                  itemDateTime = new Date(item.data.checkOutDateTime);
                } else if (item.type === 'transportation') {
                  itemDateTime = new Date(item.data.arrivalDateTime);
                } else if (item.type === 'carRental') {
                  itemDateTime = new Date(item.data.dropoffDateTime);
                } else if (item.type === 'event') {
                  itemDateTime = new Date(item.data.endDateTime || item.data.startDateTime);
                }

                if (itemDateTime) {
                  const now = new Date();
                  if (itemDateTime < now) {
                    isComplete = true;
                    completeClass = 'italic text-gray-500';
                    backgroundColor = 'bg-gray-100 opacity-50';
                  }
                }
              }

              // Don't apply non-participant styling - show all items normally
            %>
              <% if (item.type === 'flight') { %>
                <!-- Flight Card - New Layout -->
                <div class="trip-item timeline-item flex items-start justify-between p-3 rounded-lg border border-gray-200 <%= backgroundColor %> shadow-sm hover:border-gray-300 transition-colors cursor-pointer <%= nonParticipantClass %>"
                     data-item-id="<%= item.id %>"
                     data-item-type="<%= item.type %>"
                     data-marker="<%= item.marker || '' %>"
                     title="<%= nonParticipantTitle %>"
                     onmouseover="highlightMapMarker('<%= item.type %>', '<%= item.id %>')"
                     onmouseout="unhighlightMapMarker('<%= item.type %>-<%= item.id %>')"
                     onclick="editItem('<%= item.type %>', '<%= item.id %>')">

                  <!-- Left: Time and Icon in a column, aligned with flight number -->
                  <div class="flex gap-3 flex-1 items-start min-w-0">
                    <div class="flex flex-col items-center gap-1 flex-shrink-0">
                      <span class="text-xs font-medium text-gray-900 <%= completeClass %>"><%= hours %>:<%= minutes %></span>
                      <span class="material-symbols-outlined text-sm" style="color: <%= getItemHexColor('flight') %>;">flight</span>
                    </div>

                    <!-- Center: Flight details (2 rows) -->
                    <div class="flex-1 min-w-0">
                      <%
                        const flightNum = item.data.flightNumber.match(/(\d+)$/)?.[1] || '';
                        const airlineCode = item.data.flightNumber.replace(/\d+$/, '');
                        const originCity = getCityName(item.data.origin);
                        const destCity = getCityName(item.data.destination);
                      %>
                      <!-- Top row: Flight number -->
                      <p class="text-xs font-medium text-gray-900 <%= completeClass %> mb-1"><%= airlineCode %><%= flightNum %></p>
                      <!-- Bottom row: Origin and destination -->
                      <p class="text-base text-gray-600 <%= completeClass %> whitespace-nowrap"><%= originCity %> → <%= destCity %></p>
                    </div>
                  </div>

                  <!-- Right: Companion badge (floating right) -->
                  <%
                    let companionBadgeHtml = '';
                    if (isNonParticipant) {
                      const itemCompanions = trip.itemCompanions ? trip.itemCompanions.filter(ic => ic.itemType === item.type && ic.itemId === item.id) : [];
                      if (itemCompanions.length > 0) {
                        const companionFirstNames = itemCompanions.map(ic => ic.companion.name.split(' ')[0]).join(', ');
                        companionBadgeHtml = `<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-medium ml-2 flex-shrink-0 truncate ${completeClass}"">${companionFirstNames}</span>`;
                      }
                    }
                  %>
                  <% if (companionBadgeHtml) { %>
                    <%- companionBadgeHtml %>
                  <% } %>
                </div>
              <% } else { %>
                <!-- Other item types - Updated layout -->
                <div class="trip-item timeline-item flex items-start justify-between gap-2 p-3 rounded-lg border border-gray-200 <%= backgroundColor %> shadow-sm hover:border-gray-300 transition-colors cursor-pointer <%= nonParticipantClass %>"
                     data-item-id="<%= item.id %>"
                     data-item-type="<%= item.type %>"
                     data-marker="<%= item.marker || '' %>"
                     title="<%= nonParticipantTitle %>"
                     onmouseover="highlightMapMarker('<%= item.type %>', '<%= item.id %>')"
                     onmouseout="unhighlightMapMarker('<%= item.type %>-<%= item.id %>')"
                     onclick="editItem('<%= item.type %>', '<%= item.id %>')">

                  <!-- Left: Time and Icon in a column -->
                  <div class="flex gap-3 flex-1 items-start min-w-0">
                    <div class="flex flex-col items-center gap-1 flex-shrink-0">
                      <span class="text-xs font-medium text-gray-900 <%= completeClass %>"><%= hours %>:<%= minutes %></span>
                      <% if (item.type === 'hotel') { %>
                        <span class="material-symbols-outlined text-sm" style="color: <%= getItemHexColor('hotel') %>;">hotel</span>
                      <% } else if (item.type === 'transportation') { %>
                        <span class="material-symbols-outlined text-sm" style="color: <%= getItemHexColor('transportation') %>;"><%= item.icon %></span>
                      <% } else if (item.type === 'carRental') { %>
                        <span class="material-symbols-outlined text-sm" style="color: <%= getItemHexColor('carRental') %>;">directions_car</span>
                      <% } else if (item.type === 'event') { %>
                        <span class="material-symbols-outlined text-sm" style="color: <%= getItemHexColor('event') %>;">event</span>
                      <% } %>
                    </div>

                    <!-- Center: Item details -->
                    <div class="flex-1 min-w-0">
                      <p class="text-base text-gray-600 <%= completeClass %> whitespace-nowrap" style="line-height: 1em;"><%= item.display %></p>
                    </div>
                  </div>

                  <!-- Right: Companion badge (floating right) -->
                  <%
                    let companionBadgeHtml = '';
                    if (isNonParticipant) {
                      const itemCompanions = trip.itemCompanions ? trip.itemCompanions.filter(ic => ic.itemType === item.type && ic.itemId === item.id) : [];
                      if (itemCompanions.length > 0) {
                        const companionFirstNames = itemCompanions.map(ic => ic.companion.name.split(' ')[0]).join(', ');
                        companionBadgeHtml = `<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-medium ml-2 flex-shrink-0 truncate ${completeClass}"">${companionFirstNames}</span>`;
                      }
                    }
                  %>
                  <% if (companionBadgeHtml) { %>
                    <%- companionBadgeHtml %>
                  <% } %>
                </div>
              <% } %>

              <!-- Display layover information if applicable -->
              <%
                const layoverInfo = layoversByFlightId[item.id];
                if (item.type === 'flight' && layoverInfo) {
                  if (layoverInfo.type === 'short') {
              %>
                <div class="flex items-center justify-center px-2">
                  <div class="text-xs text-gray-500 font-medium layover-duration">
                    <%= layoverInfo.text %>
                  </div>
                </div>
              <%
                  } else if (layoverInfo.type === 'long') {
              %>
                <div class="accommodation-suggestion bg-amber-50 rounded-lg" onclick="showAddFormWithLayoverDates('hotel', '<%= layoverInfo.arrivalDateTime %>', '<%= layoverInfo.departureDateTime %>', '<%= layoverInfo.destinationTimezone %>')">
                  <div class="flex items-center space-x-3 p-3 w-full">
                    <span class="material-symbols-outlined text-sm flex-shrink-0" style="color: <%= getItemHexColor('hotel') %>;">hotel</span>
                    <div class="flex-1 min-w-0">
                      <p class="text-sm text-amber-900 font-medium">Do you have accommodation in <%= layoverInfo.city %>?</p>
                      <p class="text-xs text-amber-700">Add a hotel for your layover</p>
                    </div>
                    <svg class="w-4 h-4 text-amber-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </div>
                </div>
              <%
                  }
                }
              %>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>
