<!-- Hotel Form - Sidebar Only - Using Preline Components -->

<%
  const isAddMode = !isEditing;
  const submitButtonText = isAddMode ? 'Add Hotel' : 'Update Hotel';
  const headerText = isAddMode ? 'Add Hotel' : 'Edit Hotel';
%>

<div class="sidebar-form-container">
  <div class="flex items-start justify-between mb-6">
    <div class="flex items-center">
      <button onclick="<%= isAddMode ? (tripId ? 'showAddItemMenu()' : 'goBackInSidebar()') : 'closeSecondarySidebar()' %>" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <h2 class="text-lg font-bold text-gray-900"><%= headerText %></h2>
    </div>
    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
      <span class="material-symbols-outlined text-green-600" style="font-size: 16px;">hotel</span>
    </div>
  </div>

  <form id="<%= isAddMode ? 'addHotelForm' : 'editHotelForm' %>" action="<%= isAddMode ? (tripId ? `/hotels/trips/${tripId}/hotels` : '/hotels/standalone') : `/hotels/${data?.id}` %>" method="POST" class="space-y-4">
    <% if (!isAddMode) { %>
      <input type="hidden" name="_method" value="PUT">
    <% } %>
    <input type="hidden" name="timezone" id="<%= isAddMode ? 'hotelTimezone' : 'edit_hotel_timezone' %>" value="<%= data?.timezone || '' %>">

    <!-- Trip Selector Field -->
    <%- include('./trip-selector-field', { currentTripId, currentTripName, availableTrips }) %>

    <!-- Hotel Name -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Hotel Name</label>
      <input type="text" name="hotelName" id="<%= isAddMode ? '' : 'edit_hotel_hotelName' %>" value="<%= data?.hotelName || '' %>" placeholder="W Bangkok" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
    </div>

    <!-- Address -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
      <textarea name="address" id="<%= isAddMode ? '' : 'edit_hotel_address' %>" rows="2" placeholder="Full hotel address with city and country" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required><%= data?.address || '' %></textarea>
    </div>

    <!-- Phone Number -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
      <input type="tel" name="phone" id="<%= isAddMode ? '' : 'edit_hotel_phone' %>" value="<%= data?.phone || '' %>" placeholder="+1-212-5550123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
    </div>

    <!-- Check-in Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Check-in Date</label>
        <input type="date" name="checkInDate" id="<%= isAddMode ? '' : 'edit_hotel_checkInDate' %>" value="<%= (data?.checkInDate && data.checkInDate !== 'undefined') ? data.checkInDate : '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Check-in Time</label>
        <input type="text" name="checkInTime" id="<%= isAddMode ? '' : 'edit_hotel_checkInTime' %>" data-time-input value="<%= (data?.checkInTime && data.checkInTime !== 'undefined') ? data.checkInTime : '14:00' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
      </div>
    </div>

    <!-- Check-out Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Check-out Date</label>
        <input type="date" name="checkOutDate" id="<%= isAddMode ? '' : 'edit_hotel_checkOutDate' %>" value="<%= (data?.checkOutDate && data.checkOutDate !== 'undefined') ? data.checkOutDate : '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Check-out Time</label>
        <input type="text" name="checkOutTime" id="<%= isAddMode ? '' : 'edit_hotel_checkOutTime' %>" data-time-input value="<%= (data?.checkOutTime && data.checkOutTime !== 'undefined') ? data.checkOutTime : '11:00' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
      </div>
    </div>

    <!-- Confirmation & Room Number -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmation Number</label>
        <input type="text" name="confirmationNumber" id="<%= isAddMode ? '' : 'edit_hotel_confirmationNumber' %>" value="<%= data?.confirmationNumber || '' %>" placeholder="Booking confirmation number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Room Number</label>
        <input type="text" name="roomNumber" id="<%= isAddMode ? '' : 'edit_hotel_roomNumber' %>" value="<%= data?.roomNumber || '' %>" placeholder="1205" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
    </div>

    <!-- Travel Companions Section -->
    <%- include('./item-companions-section') %>

    <!-- Set context for companion loading -->
    <script>
      window.itemType = 'hotel';
      window.itemId = '<%= data?.id || "" %>';
      window.tripId = '<%= tripId %>';
      // Companions are initialized by parent script (trip-view-sidebar.js) via ensureCompanionsInitialized()
    </script>

    <!-- Buttons -->
    <div class="flex space-x-3 pt-4">
      <button type="submit" class="flex-1 <%= isAddMode ? 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500' : 'bg-green-600 hover:bg-green-700 focus:ring-green-500' %> text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors">
        <%= submitButtonText %>
      </button>
      <button type="button" data-action="closeSecondarySidebar" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
        Cancel
      </button>
    </div>
  </form>

  <% if (!isAddMode) { %>
    <form action="/hotels/<%= data?.id %>?_method=DELETE" method="POST" class="mt-4 pt-4 border-t border-gray-200">
      <input type="hidden" name="tripId" value="<%= tripId %>">
      <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors" onclick="return confirm('Are you sure you want to delete this hotel?')">
        Delete Hotel
      </button>
    </form>
  <% } %>
</div>

<script>
function initializeHotelDateSync() {
  const checkInDateInput = document.querySelector('input[name="checkInDate"]');
  const checkOutDateInput = document.querySelector('input[name="checkOutDate"]');

  if (checkInDateInput && checkOutDateInput) {
    checkInDateInput.addEventListener('change', function() {
      const checkInDate = this.value;
      const checkOutDate = checkOutDateInput.value;

      // Case 1: Check-out date is blank - auto-fill with check-in date
      if (!checkOutDate) {
        checkOutDateInput.value = checkInDate;
      }
      // Case 2: Check-in date is after check-out date - update check-out date to match check-in date
      else if (checkInDate > checkOutDate) {
        checkOutDateInput.value = checkInDate;
      }
      // Case 3: Check-in date is before check-out date - leave check-out date unchanged
    });
  }
}

function initializeHotelTimezoneUpdate() {
  const addressInput = document.querySelector('textarea[name="address"]');
  const timezoneField = document.getElementById('hotelTimezone') || document.getElementById('edit_hotel_timezone');

  if (addressInput && timezoneField) {
    // Function to infer timezone from address
    async function inferAndUpdateTimezone(address) {
      if (!address || address.trim().length === 0) return;

      try {
        // Use the existing geocoding service to get timezone
        const response = await fetch(`/api/v1/geocode?address=${encodeURIComponent(address)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.timezone) {
            timezoneField.value = data.timezone;
          }
        }
      } catch (error) {
      }
    }

    // IMPORTANT: Infer timezone on initial form load if address is present
    // This ensures editing existing hotels gets the correct timezone
    const initialAddress = addressInput.value;
    if (initialAddress && initialAddress.trim().length > 0) {
      // Only infer on load if timezone field is empty (form is being edited but timezone wasn't set)
      if (!timezoneField.value || timezoneField.value === '') {
        inferAndUpdateTimezone(initialAddress);
      }
    }

    // Debounce the address input to avoid too many API calls
    let timeoutId;
    addressInput.addEventListener('blur', function() {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        inferAndUpdateTimezone(this.value);
      }, 500);
    });
  }
}

// Add form submission handler to ensure timezone is never empty
function ensureTimezoneBeforeSubmit() {
  const form = document.getElementById('addHotelForm') || document.getElementById('editHotelForm');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    const timezoneField = document.getElementById('hotelTimezone') || document.getElementById('edit_hotel_timezone');

    // If timezone is still empty, set it to UTC as fallback
    if (timezoneField && (!timezoneField.value || timezoneField.value.trim() === '')) {
      timezoneField.value = 'UTC';
    }
  });
}

// Call on initial page load
document.addEventListener('DOMContentLoaded', () => {
  initializeHotelDateSync();
  initializeHotelTimezoneUpdate();
  ensureTimezoneBeforeSubmit();
});

// Also call immediately in case the form is already loaded
initializeHotelDateSync();
initializeHotelTimezoneUpdate();
ensureTimezoneBeforeSubmit();
</script>
