<!-- Flight Form - Sidebar Only - Using Preline Components -->

<%
  const isAddMode = !isEditing;
  const submitButtonText = isAddMode ? 'Add Flight' : 'Update Flight';
  const headerText = isAddMode ? 'Add Flight' : 'Edit Flight';
  const itemType = 'flight';
  const itemColor = getItemHexColor(itemType);
%>

<div class="sidebar-form-container" data-item-type="<%= itemType %>">
  <div class="flex items-start justify-between mb-6">
    <div class="flex items-center">
      <button onclick="<%= isAddMode ? (tripId ? 'showAddItemMenu()' : 'goBackInSidebar()') : 'closeSecondarySidebar()' %>" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <h2 class="text-lg font-bold text-gray-900"><%= headerText %></h2>
    </div>
    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" data-icon-badge style="background-color: <%= itemColor %>22;">
      <span class="material-symbols-outlined" style="font-size: 16px; color: <%= itemColor %>;">flight</span>
    </div>
  </div>

  <form id="<%= isAddMode ? 'addFlightForm' : 'editFlightForm' %>" action="<%= isAddMode ? (tripId ? `/flights/trips/${tripId}/flights` : '/flights/standalone') : `/flights/${data?.id}` %>" method="POST" class="space-y-4">
    <% if (!isAddMode) { %>
      <input type="hidden" name="_method" value="PUT">
    <% } %>

    <!-- Trip Selector Field -->
    <%- include('./trip-selector-field', { currentTripId, currentTripName, availableTrips }) %>

    <!-- Flight Number & Airline -->
    <div class="grid grid-cols-3 gap-3">
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Flight Number</label>
        <input type="text" name="flightNumber" id="flightNumberInput" value="<%= data?.flightNumber || '' %>" placeholder="KL668" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" required>
      </div>
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">Airline</label>
        <input type="text" name="airline" id="flightAirlineInput" value="<%= data?.airline || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100" readonly required>
      </div>
    </div>

    <!-- Origin & Destination - AJAX Autocomplete -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Origin</label>
        <div class="relative" data-airport-autocomplete>
          <div class="relative">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 pr-9" type="text" name="origin" id="<%= isAddMode ? 'originInput' : 'edit_flight_origin' %>" placeholder="AUS" value="<%= data?.origin || '' %>" data-airport-input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" required>
            <div class="absolute right-2 top-2.5 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
          </div>
          <div class="absolute z-50 w-full max-h-72 p-1 bg-white border border-gray-200 rounded-lg shadow-md overflow-y-auto hidden" data-airport-dropdown></div>
        </div>
        <input type="hidden" name="originTimezone" id="<%= isAddMode ? 'originTimezone' : 'edit_flight_originTimezone' %>" value="<%= data?.originTimezone || '' %>">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
        <div class="relative" data-airport-autocomplete>
          <div class="relative">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 pr-9" type="text" name="destination" id="<%= isAddMode ? 'destinationInput' : 'edit_flight_destination' %>" placeholder="AMS" value="<%= data?.destination || '' %>" data-airport-input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" required>
            <div class="absolute right-2 top-2.5 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
          </div>
          <div class="absolute z-50 w-full max-h-72 p-1 bg-white border border-gray-200 rounded-lg shadow-md overflow-y-auto hidden" data-airport-dropdown></div>
        </div>
        <input type="hidden" name="destinationTimezone" id="<%= isAddMode ? 'destinationTimezone' : 'edit_flight_destinationTimezone' %>" value="<%= data?.destinationTimezone || '' %>">
      </div>
    </div>

    <!-- Departure Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Departure Date</label>
        <input type="date" name="departureDate" id="<%= isAddMode ? 'add_flight_departureDate' : 'edit_flight_departureDate' %>" value="<%= data?.departureDate || '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Departure Time</label>
        <input type="text" name="departureTime" id="<%= isAddMode ? 'add_flight_departureTime' : 'edit_flight_departureTime' %>" data-time-input value="<%= data?.departureTime || '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
    </div>

    <!-- Arrival Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Date</label>
        <input type="date" name="arrivalDate" id="<%= isAddMode ? 'add_flight_arrivalDate' : 'edit_flight_arrivalDate' %>" value="<%= data?.arrivalDate || '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Time</label>
        <input type="text" name="arrivalTime" id="<%= isAddMode ? 'add_flight_arrivalTime' : 'edit_flight_arrivalTime' %>" data-time-input value="<%= data?.arrivalTime || '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
    </div>

    <!-- PNR & Seat -->
    <div class="grid grid-cols-3 gap-3">
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">PNR</label>
        <input type="text" name="pnr" id="<%= isAddMode ? 'add_flight_pnr' : 'edit_flight_pnr' %>" value="<%= data?.pnr || '' %>" placeholder="ABC123D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Seat</label>
        <input type="text" name="seat" id="<%= isAddMode ? 'add_flight_seat' : 'edit_flight_seat' %>" value="<%= data?.seat || '' %>" placeholder="4A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>

    <!-- Vouchers Section (Edit Mode Only) -->
    <% if (!isAddMode && data?.id) { %>
      <%- include('./flight-vouchers-section', { flight: data, trip: { id: tripId }, isOwner: true }) %>
    <% } %>

    <!-- Travel Companions Section -->
    <%- include('./item-companions-section') %>

    <!-- Set context for companion loading -->
    <div id="airline-data" data-airlines="<%= airlineData ? airlineData : '[]' %>" style="display: none;"></div>
    <script>
      window.itemType = 'flight';
      window.itemId = '<%= data?.id || "" %>';
      window.tripId = '<%= tripId %>';
      // Companions are initialized by parent script (trip-view-sidebar.js) via ensureCompanionsInitialized()

      // Initialize airline data for lookupAirline function
      try {
        const airlineDataEl = document.getElementById('airline-data');
        if (airlineDataEl && airlineDataEl.getAttribute('data-airlines')) {
          window.airlineData = JSON.parse(airlineDataEl.getAttribute('data-airlines'));
        }
      } catch (e) {
        window.airlineData = [];
      }
    </script>

    <!-- Buttons -->
    <div class="flex space-x-3 pt-4">
      <button type="submit" class="flex-1 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors" style="background-color: <%= getApproveColor() %>;">
        <%= submitButtonText %>
      </button>
      <button type="button" data-action="closeSecondarySidebar" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
        Cancel
      </button>
    </div>
  </form>

  <% if (!isAddMode) { %>
    <form action="/flights/<%= data?.id %>?_method=DELETE" method="POST" class="mt-4 pt-4 border-t border-gray-200">
      <input type="hidden" name="tripId" value="<%= tripId %>">
      <button type="submit" class="w-full text-white py-2 px-4 rounded-md transition-colors" style="background-color: <%= getDeclineColor() %>; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" onclick="return confirm('Are you sure you want to delete this flight?')">
        Delete Flight
      </button>
    </form>
  <% } %>
</div>

<script>
// Load form utilities module
const formUtilitiesScript = document.createElement('script');
formUtilitiesScript.src = '/js/form-utilities.js';
formUtilitiesScript.onload = initializeFlightForm;
document.head.appendChild(formUtilitiesScript);

// Load airport autocomplete module
const autocompleteScript = document.createElement('script');
autocompleteScript.src = '/js/airport-autocomplete.js';
autocompleteScript.type = 'module';
document.head.appendChild(autocompleteScript);

function initializeFlightForm() {
  // Use shared date sync utility for departure/arrival dates
  initializeDateSync('input[name="departureDate"]', 'input[name="arrivalDate"]');

  // Use shared timezone inference utility for origin/destination
  const originTzFieldId = '<%= isAddMode ? "originTimezone" : "edit_flight_originTimezone" %>';
  const destTzFieldId = '<%= isAddMode ? "destinationTimezone" : "edit_flight_destinationTimezone" %>';
  initializeOriginDestTimezoneInference('origin', 'destination', originTzFieldId, destTzFieldId);

  // Airline lookup logic (specific to flights)
  function updateAirline() {
    const flightNumberInput = document.querySelector('input[name="flightNumber"]');
    const airlineInput = document.getElementById('flightAirlineInput');

    if (!flightNumberInput || !airlineInput) {
      return;
    }

    const flightNumber = flightNumberInput.value.trim().toUpperCase();

    if (flightNumber.length < 1) {
      airlineInput.value = '';
      return;
    }

    // Extract first 1-3 characters as airline code
    const airlineCode = flightNumber.match(/^([A-Z0-9]{1,3})/)?.[1] || '';

    if (!airlineCode) {
      airlineInput.value = '';
      return;
    }

    // Temporarily remove readonly to allow value updates
    airlineInput.removeAttribute('readonly');

    // Use the global lookupAirline function from trip-view-utils.js
    if (typeof lookupAirline === 'function') {
      lookupAirline(flightNumber, 'flightAirlineInput');
    }

    // Re-add readonly
    airlineInput.setAttribute('readonly', 'readonly');
  }

  function extractAirportCode(value) {
    // Extract IATA code from various formats:
    // "[AAA] City", "AAA - City, Country", "AAA" => "AAA"
    const match = value.match(/\[?([A-Z]{3})\]?/);
    return match ? match[1] : null;
  }

  async function updateAirportFromCode(input) {
    const value = input.value.trim().toUpperCase();
    const code = extractAirportCode(value);

    if (!code || code.length !== 3) {
      return;
    }

    try {
      // Fetch airport data from API
      const response = await fetch(`/api/v1/airports/${code}`);

      if (!response.ok) {
        return;
      }

      const data = await response.json();

      if (data.success && data.airport) {
        const airport = data.airport;

        // Keep only the airport code, no formatting
        input.value = code;

        // Update timezone hidden field if it exists
        if (input.name === 'origin') {
          const timezoneField = document.getElementById('originTimezone') ||
                                document.getElementById('edit_flight_originTimezone');
          if (timezoneField) {
            timezoneField.value = airport.timezone || '';
          }
        } else if (input.name === 'destination') {
          const timezoneField = document.getElementById('destinationTimezone') ||
                                document.getElementById('edit_flight_destinationTimezone');
          if (timezoneField) {
            timezoneField.value = airport.timezone || '';
          }
        }
      }
    } catch (error) {
    }
  }

  function handleOriginBlur() {
    const value = this.value.trim().toUpperCase();
    // Try to extract and validate airport code from any format
    const code = extractAirportCode(value);
    if (code) {
      updateAirportFromCode(this);
    } else if (value.length === 3 && /^[A-Z]{3}$/.test(value)) {
      // If it's exactly 3 letters, treat it as a code
      updateAirportFromCode(this);
    }
  }

  function handleDestinationBlur() {
    const value = this.value.trim().toUpperCase();
    // Try to extract and validate airport code from any format
    const code = extractAirportCode(value);
    if (code) {
      updateAirportFromCode(this);
    } else if (value.length === 3 && /^[A-Z]{3}$/.test(value)) {
      // If it's exactly 3 letters, treat it as a code
      updateAirportFromCode(this);
    }
  }

  function reformatAirportField(input) {
    // Reformat existing airport values on initial load
    if (input.value) {
      updateAirportFromCode(input);
    }
  }

  // Setup AJAX autocomplete for airport inputs
  function setupAirportAutocomplete(input) {
    let searchTimeout;
    const comboboxWrapper = input.closest('[data-hs-combobox]');
    if (!comboboxWrapper) return;

    const dropdown = comboboxWrapper.querySelector('[data-hs-combobox-output]');
    const itemsWrapper = dropdown?.querySelector('[data-hs-combobox-output-items-wrapper]');
    if (!itemsWrapper) return;

    // Clear default template
    itemsWrapper.innerHTML = '';

    input.addEventListener('input', function() {
      const query = this.value.trim();

      // Clear timeout
      clearTimeout(searchTimeout);

      if (query.length < 2) {
        dropdown.classList.add('hidden');
        return;
      }

      // Debounce search
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/flights/airports/search?query=${encodeURIComponent(query)}`);
          const result = await response.json();

          if (result.success && result.data && result.data.length > 0) {
            // Clear previous results
            itemsWrapper.innerHTML = '';

            // Add new results
            result.data.forEach((airport) => {
              const item = document.createElement('div');
              item.className = 'cursor-pointer py-2 px-4 w-full text-sm text-gray-800 hover:bg-gray-100 rounded-lg focus:outline-none focus:bg-gray-100';
              item.setAttribute('tabindex', '0');
              item.setAttribute('data-airport-iata', airport.iata);
              item.setAttribute('data-airport-timezone', airport.timezone || '');
              item.innerHTML = `<span>${airport.label}</span>`;

              // Handle selection
              item.addEventListener('click', function() {
                input.value = airport.iata;

                // Update timezone
                const timezoneField = input.name === 'origin'
                  ? (document.getElementById('originTimezone') || document.getElementById('edit_flight_originTimezone'))
                  : (document.getElementById('destinationTimezone') || document.getElementById('edit_flight_destinationTimezone'));

                if (timezoneField) {
                  timezoneField.value = airport.timezone || '';
                }

                dropdown.classList.add('hidden');
              });

              itemsWrapper.appendChild(item);
            });

            dropdown.classList.remove('hidden');
          } else {
            dropdown.classList.add('hidden');
          }
        } catch (error) {
          dropdown.classList.add('hidden');
        }
      }, 300);
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!comboboxWrapper.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });
  }

  // Set up event listeners
  const flightNumberInput = document.querySelector('input[name="flightNumber"]');
  if (flightNumberInput) {
    // Remove old listeners to avoid duplicates
    flightNumberInput.removeEventListener('blur', updateAirline);
    flightNumberInput.removeEventListener('input', updateAirline);
    // Add new listeners
    flightNumberInput.addEventListener('blur', updateAirline);
    flightNumberInput.addEventListener('input', updateAirline);
  }

  const originInput = document.querySelector('input[name="origin"]');
  if (originInput) {
    originInput.removeEventListener('blur', handleOriginBlur);
    originInput.addEventListener('blur', handleOriginBlur);
    // Setup AJAX autocomplete
    setupAirportAutocomplete(originInput);
    // Reformat on initial load
    reformatAirportField(originInput);
  }

  const destinationInput = document.querySelector('input[name="destination"]');
  if (destinationInput) {
    destinationInput.removeEventListener('blur', handleDestinationBlur);
    destinationInput.addEventListener('blur', handleDestinationBlur);
    // Setup AJAX autocomplete
    setupAirportAutocomplete(destinationInput);
    // Reformat on initial load
    reformatAirportField(destinationInput);
  }

  // Expose airport code extraction for use during form submission
  window.cleanupFlightFormAirports = function() {
    // Clean up origin field
    if (originInput && originInput.value) {
      const originCode = extractAirportCode(originInput.value.trim().toUpperCase());
      if (originCode) {
        originInput.value = originCode;
      }
    }

    // Clean up destination field
    if (destinationInput && destinationInput.value) {
      const destCode = extractAirportCode(destinationInput.value.trim().toUpperCase());
      if (destCode) {
        destinationInput.value = destCode;
      }
    }
  };
}
</script>
