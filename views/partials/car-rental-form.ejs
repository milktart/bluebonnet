<!-- Car Rental Form - Sidebar Only - Using Preline Components -->

<%
  const isAddMode = !isEditing;
  const submitButtonText = isAddMode ? 'Add Car Rental' : 'Update Car Rental';
  const headerText = isAddMode ? 'Add Car Rental' : 'Edit Car Rental';
%>

<%
  const itemType = 'car_rental';
  const itemColor = getItemHexColor(itemType);
%>

<div class="sidebar-form-container" data-item-type="<%= itemType %>">
  <div class="flex items-start justify-between mb-6">
    <div class="flex items-center">
      <button onclick="<%= isAddMode ? (tripId ? 'showAddItemMenu()' : 'goBackInSidebar()') : 'closeSecondarySidebar()' %>" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <h2 class="text-lg font-bold text-gray-900"><%= headerText %></h2>
    </div>
    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" data-icon-badge style="background-color: <%= itemColor %>22;">
      <span class="material-symbols-outlined" style="font-size: 16px; color: <%= itemColor %>;">directions_car</span>
    </div>
  </div>

  <form id="<%= isAddMode ? 'addCarRentalForm' : 'editCarRentalForm' %>" action="<%= isAddMode ? (tripId ? `/car-rentals/trips/${tripId}/car-rentals` : '/car-rentals/standalone') : `/car-rentals/${data?.id}` %>" method="POST" class="space-y-4">
    <% if (!isAddMode) { %>
      <input type="hidden" name="_method" value="PUT">
    <% } %>

    <!-- Trip Selector -->
    <%- include('./trip-selector-field', { currentTripId, currentTripName, availableTrips }) %>

    <!-- Rental Company -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Rental Company</label>
      <input type="text" name="company" id="<%= isAddMode ? '' : 'edit_carRental_company' %>" value="<%= data?.company || '' %>" placeholder="Avis, Hertz, Enterprise" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
    </div>

    <!-- Pick-up Location -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Pick-up Location</label>
      <textarea name="pickupLocation" id="<%= isAddMode ? '' : 'edit_carRental_pickupLocation' %>" rows="2" placeholder="Full pick-up address with city" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required><%= data?.pickupLocation || '' %></textarea>
      <input type="hidden" name="pickupTimezone" id="<%= isAddMode ? '' : 'edit_carRental_pickupTimezone' %>" value="<%= data?.pickupTimezone || '' %>">
    </div>

    <!-- Drop-off Location -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Drop-off Location</label>
      <textarea name="dropoffLocation" id="<%= isAddMode ? '' : 'edit_carRental_dropoffLocation' %>" rows="2" placeholder="Full drop-off address with city" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required><%= data?.dropoffLocation || '' %></textarea>
      <small class="text-sm text-gray-500 mt-1">Can be different from pick-up</small>
      <input type="hidden" name="dropoffTimezone" id="<%= isAddMode ? '' : 'edit_carRental_dropoffTimezone' %>" value="<%= data?.dropoffTimezone || '' %>">
    </div>

    <!-- Pick-up Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Pick-up Date</label>
        <input type="date" name="pickupDate" id="<%= isAddMode ? '' : 'edit_carRental_pickupDate' %>" value="<%= data?.pickupDate || '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Pick-up Time</label>
        <input type="text" name="pickupTime" id="<%= isAddMode ? '' : 'edit_carRental_pickupTime' %>" data-time-input value="<%= data?.pickupTime || '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
      </div>
    </div>

    <!-- Drop-off Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Drop-off Date</label>
        <input type="date" name="dropoffDate" id="<%= isAddMode ? '' : 'edit_carRental_dropoffDate' %>" value="<%= data?.dropoffDate || '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Drop-off Time</label>
        <input type="text" name="dropoffTime" id="<%= isAddMode ? '' : 'edit_carRental_dropoffTime' %>" data-time-input value="<%= data?.dropoffTime || '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
      </div>
    </div>

    <!-- Confirmation Number -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Confirmation Number</label>
      <input type="text" name="confirmationNumber" id="<%= isAddMode ? '' : 'edit_carRental_confirmationNumber' %>" value="<%= data?.confirmationNumber || '' %>" placeholder="Reservation confirmation number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
    </div>

    <!-- Travel Companions Section -->
    <%- include('./item-companions-section') %>

    <!-- Set context for companion loading -->
    <script>
      window.itemType = 'car_rental';
      window.itemId = '<%= data?.id || "" %>';
      window.tripId = '<%= tripId %>';
      // Companions are initialized by parent script (trip-view-sidebar.js) via ensureCompanionsInitialized()
    </script>

    <!-- Buttons -->
    <div class="flex space-x-3 pt-4">
      <button type="submit" class="flex-1 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors" style="background-color: <%= getApproveColor() %>;">
        <%= submitButtonText %>
      </button>
      <button type="button" data-action="closeSecondarySidebar" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
        Cancel
      </button>
    </div>
  </form>

  <% if (!isAddMode) { %>
    <div class="mt-4 pt-4 border-t border-gray-200">
      <button type="button" class="w-full text-white py-2 px-4 rounded-md transition-colors" style="background-color: <%= getDeclineColor() %>; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" onclick="deleteItem('carRental', '<%= data?.id %>', 'car rental')">
        Delete Car Rental
      </button>
    </div>
  <% } %>
</div>

<script>
function initializeCarRentalForm() {
  // Use shared date sync utility for pickup/dropoff dates
  initializeDateSync('input[name="pickupDate"]', 'input[name="dropoffDate"]');
}
</script>

<script src="/js/form-loader.js" onload="setupCarRentalFormInit();"></script>
