<!-- Manage Travel Companions Sidebar -->
<div>
  <!-- Header with Close Button -->
  <div class="flex items-center justify-between mb-6 gap-2">
    <h2 class="text-lg font-bold text-gray-900 truncate">Manage Companions</h2>
    <button data-action="closeSecondarySidebar" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <div class="space-y-6">
    <!-- Add Companion Button -->
    <button data-action="loadSidebarContent" data-url="/companions/sidebar/create" class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      Add Companion
    </button>

    <!-- Section 1: Mutual Companions (Accepted Relationships) -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
      <h3 class="text-sm font-semibold text-gray-900 mb-4 flex items-center">
        <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        Active Companions
      </h3>
      <div id="mutualCompanionsList" class="space-y-3">
        <!-- Populated by JavaScript -->
        <div class="text-gray-500 text-sm text-center py-2">Loading...</div>
      </div>
    </div>

  </div>
</div>

<script>
// Load all companion data immediately (not waiting for DOMContentLoaded since this is loaded via AJAX)
async function loadCompanionData() {
  try {
    // Load travel companions (simple contacts created for trips)
    const companionsRes = await fetch('/companions/api/json');
    const companionsData = await companionsRes.json();

    if (companionsData.success) {
      renderMutualCompanions(companionsData.companions || []);
    }
  } catch (error) {
  }
}

function renderMutualCompanions(companions) {
  const container = document.getElementById('mutualCompanionsList');

  if (!companions || companions.length === 0) {
    container.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">No active companions yet</div>';
    return;
  }

  container.innerHTML = companions.map(companion => {
    const accountStatus = companion.linkedAccount ?
      `<span class="inline-block mt-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded">âœ“ Account Linked</span>` :
      `<span class="inline-block mt-2 px-2 py-1 text-xs bg-amber-100 text-amber-800 rounded">Account: Not Linked</span>`;

    return `
      <div class="flex justify-between items-start p-3 bg-gray-50 rounded-md">
        <div class="flex-grow">
          <p class="text-sm font-medium text-gray-900">${companion.name}</p>
          <p class="text-xs text-gray-600">${companion.email}</p>
          ${companion.phone ? `<p class="text-xs text-gray-600 mt-1">${companion.phone}</p>` : ''}
          <div>
            ${accountStatus}
          </div>
        </div>
        <div class="flex gap-2 ml-2">
          <button class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200" onclick="editCompanion('${companion.id}')">
            Edit
          </button>
          <button class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" onclick="deleteCompanionClick('${companion.id}')">
            Delete
          </button>
        </div>
      </div>
    `;
  }).join('');
}

async function editCompanion(companionId) {
  try {
    // Load the edit form in the secondary sidebar
    if (typeof window.loadSidebarContent === 'function') {
      await window.loadSidebarContent(`/companions/${companionId}/sidebar/edit`);
    } else {
      alert('Error loading edit form');
    }
  } catch (error) {
    alert('Error loading edit form');
  }
}

async function deleteCompanionClick(companionId) {
  if (!confirm('Are you sure you want to delete this companion?')) return;

  try {
    const response = await fetch(`/companions/${companionId}`, {
      method: 'DELETE',
      headers: {
        'X-Sidebar-Request': 'true'
      }
    });

    if (response.ok) {
      // Reload companion data to reflect the deletion
      loadCompanionData();
      alert('Companion deleted successfully');
    } else {
      const data = await response.json();
      alert(data.error || 'Error deleting companion');
    }
  } catch (error) {
    alert('Error deleting companion');
  }
}

// Load companion data when sidebar is opened
loadCompanionData();
</script>
