<!-- Vouchers Management Sidebar -->
<div class="h-full flex flex-col">
  <% const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; %>

  <!-- Header with close button -->
  <div class="flex items-center justify-between mb-6 pb-6 border-b border-gray-200">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
        <span class="material-symbols-outlined text-amber-600" style="font-size: 20px;">wallet</span>
      </div>
      <h2 class="text-lg font-bold text-gray-900">Manage Certificates & Vouchers</h2>
    </div>
    <button onclick="window.history.pushState({}, '', '/'); closeTertiarySidebar(); closeSecondarySidebar();" class="text-gray-400 hover:text-gray-600">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <!-- Tabs -->
  <div class="flex space-x-4 mb-6 border-b border-gray-200 -mx-6 px-6">
    <button id="open-vouchers-tab" class="py-3 px-4 border-b-2 border-blue-500 font-medium text-sm text-blue-600 bg-blue-50 transition-all duration-200" onclick="switchVouchersTab('open')">
      <div class="flex items-center space-x-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span>Open Vouchers</span>
      </div>
    </button>
    <button id="closed-vouchers-tab" class="py-3 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all duration-200" onclick="switchVouchersTab('closed')">
      <div class="flex items-center space-x-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span>Closed Vouchers</span>
      </div>
    </button>
  </div>

  <!-- Scrollable Content -->
  <div class="flex-1 overflow-y-auto">
    <!-- Open Vouchers Tab -->
    <div id="open-vouchers-content" class="p-4">
      <% if (openVouchers && openVouchers.length === 0) { %>
        <div class="text-center py-12">
          <p class="text-gray-500 font-medium">No open vouchers</p>
          <p class="text-xs text-gray-400 mt-1">You don't have any active vouchers at the moment</p>
        </div>
      <% } else if (openVouchers) { %>
        <div class="overflow-x-auto border border-gray-300 rounded-md">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-300">
              <tr>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Issuer & Number</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Type</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Status</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Balance</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Expires</th>
              </tr>
            </thead>
            <tbody>
              <% openVouchers.forEach(voucher => { %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors" onclick="openVoucherDetails('<%= voucher.id %>', 'open')" data-voucher-id="<%= voucher.id %>">
                  <td class="px-3 py-3">
                    <div class="font-medium text-gray-900 text-xs"><%= voucher.issuer %></div>
                    <div class="text-xs text-gray-500 font-mono"><%= voucher.voucherNumber %></div>
                  </td>
                  <td class="px-3 py-3">
                    <%
                      let typeColor;
                      if (voucher.type === 'TRAVEL_CREDIT') {
                        typeColor = 'bg-green-100 text-green-800';
                      } else if (voucher.type === 'UPGRADE_CERT' || voucher.type === 'REGIONAL_UPGRADE_CERT' || voucher.type === 'GLOBAL_UPGRADE_CERT') {
                        typeColor = 'bg-purple-100 text-purple-800';
                      } else if (voucher.type === 'COMPANION_CERT') {
                        typeColor = 'bg-pink-100 text-pink-800';
                      } else if (voucher.type === 'GIFT_CARD') {
                        typeColor = 'bg-yellow-100 text-yellow-800';
                      } else {
                        typeColor = 'bg-gray-100 text-gray-800';
                      }
                    %>
                    <span class="px-2 py-1 rounded text-xs font-medium <%= typeColor %>">
                      <%= voucher.type.replace(/_/g, ' ') %>
                    </span>
                  </td>
                  <td class="px-3 py-3">
                    <% if (voucher.status === 'OPEN') { %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
                    <% } else if (voucher.status === 'PARTIALLY_USED') { %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">In Use</span>
                    <% } %>
                  </td>
                  <td class="px-3 py-3">
                    <% if (voucher.totalValue) { %>
                      <div class="font-semibold text-gray-900 text-xs"><%= voucher.currency %> <%= parseFloat(voucher.remainingBalance || 0).toFixed(2) %></div>
                      <div class="text-xs text-gray-500">of <%= parseFloat(voucher.totalValue).toFixed(2) %></div>
                    <% } else { %>
                      <div class="font-semibold text-purple-600 text-xs">Certificate</div>
                    <% } %>
                  </td>
                  <td class="px-3 py-3">
                    <% if (voucher.expirationDate) { %>
                      <%
                        const expDate = new Date(voucher.expirationDate);
                        const day = String(expDate.getDate()).padStart(2, '0');
                        const month = months[expDate.getMonth()];
                        const year = expDate.getFullYear();
                      %>
                      <div class="text-gray-900 text-xs"><%= day %> <%= month %> <%= year %></div>
                      <% if (voucher.daysUntilExpiration !== null) { %>
                        <div class="text-xs <% if (voucher.daysUntilExpiration <= 30) { %>text-red-600<% } else { %>text-gray-500<% } %>">
                          <% if (voucher.daysUntilExpiration <= 0) { %>Expired<% } else if (voucher.daysUntilExpiration <= 30) { %>Expires in <%= voucher.daysUntilExpiration %> days<% } else { %><%= voucher.daysUntilExpiration %> days<% } %>
                        </div>
                      <% } %>
                    <% } else { %>
                      <div class="text-gray-600 text-xs">No expiration</div>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>

    <!-- Closed Vouchers Tab -->
    <div id="closed-vouchers-content" class="p-4 hidden">
      <% if (closedVouchers && closedVouchers.length === 0) { %>
        <div class="text-center py-12">
          <p class="text-gray-500 font-medium">No closed vouchers</p>
          <p class="text-xs text-gray-400 mt-1">Your used or expired vouchers will appear here</p>
        </div>
      <% } else if (closedVouchers) { %>
        <div class="overflow-x-auto border border-gray-300 rounded-md">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-300">
              <tr>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Issuer & Number</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Type</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Status</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Balance</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700">Closed Date</th>
              </tr>
            </thead>
            <tbody>
              <% closedVouchers.forEach(voucher => { %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors" onclick="openVoucherDetails('<%= voucher.id %>', 'closed')" data-voucher-id="<%= voucher.id %>">
                  <td class="px-3 py-3">
                    <div class="font-medium text-gray-900 text-xs"><%= voucher.issuer %></div>
                    <div class="text-xs text-gray-500 font-mono"><%= voucher.voucherNumber %></div>
                  </td>
                  <td class="px-3 py-3">
                    <%
                      let typeColor;
                      if (voucher.type === 'TRAVEL_CREDIT') {
                        typeColor = 'bg-green-100 text-green-800';
                      } else if (voucher.type === 'UPGRADE_CERT' || voucher.type === 'REGIONAL_UPGRADE_CERT' || voucher.type === 'GLOBAL_UPGRADE_CERT') {
                        typeColor = 'bg-purple-100 text-purple-800';
                      } else if (voucher.type === 'COMPANION_CERT') {
                        typeColor = 'bg-pink-100 text-pink-800';
                      } else if (voucher.type === 'GIFT_CARD') {
                        typeColor = 'bg-yellow-100 text-yellow-800';
                      } else {
                        typeColor = 'bg-gray-100 text-gray-800';
                      }
                    %>
                    <span class="px-2 py-1 rounded text-xs font-medium <%= typeColor %>">
                      <%= voucher.type.replace(/_/g, ' ') %>
                    </span>
                  </td>
                  <td class="px-3 py-3">
                    <% if (voucher.status === 'USED') { %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Used</span>
                    <% } else if (voucher.status === 'EXPIRED') { %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Expired</span>
                    <% } else if (voucher.status === 'TRANSFERRED') { %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Transferred</span>
                    <% } else if (voucher.status === 'CANCELLED') { %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Cancelled</span>
                    <% } %>
                  </td>
                  <td class="px-3 py-3">
                    <% if (voucher.totalValue) { %>
                      <div class="font-semibold text-gray-900 text-xs"><%= voucher.currency %> <%= parseFloat(voucher.remainingBalance || 0).toFixed(2) %></div>
                      <div class="text-xs text-gray-500">of <%= parseFloat(voucher.totalValue).toFixed(2) %></div>
                    <% } else { %>
                      <div class="font-semibold text-purple-600 text-xs">Certificate</div>
                    <% } %>
                  </td>
                  <td class="px-3 py-3">
                    <%
                      const updatedDate = new Date(voucher.updatedAt);
                      const updDay = String(updatedDate.getDate()).padStart(2, '0');
                      const updMonth = months[updatedDate.getMonth()];
                      const updYear = updatedDate.getFullYear();
                    %>
                    <div class="text-gray-900 text-xs"><%= updDay %> <%= updMonth %> <%= updYear %></div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Vouchers Sidebar Script -->
<script>
  // Ensure tertiary sidebar functions exist (for dashboard page which doesn't load trip-view-sidebar.js)
  if (typeof window.openTertiarySidebar === 'undefined') {
    window.openTertiarySidebar = function() {
      const tertiarySidebar = document.getElementById('tertiary-sidebar');
      if (tertiarySidebar) {
        tertiarySidebar.classList.add('open');
      }
    };
  }

  if (typeof window.closeTertiarySidebar === 'undefined') {
    window.closeTertiarySidebar = function() {
      const tertiarySidebar = document.getElementById('tertiary-sidebar');
      if (tertiarySidebar) {
        tertiarySidebar.classList.remove('open');
      }
    };
  }

  // Switch between tabs
  function switchVouchersTab(tabName) {
    const openTab = document.getElementById('open-vouchers-tab');
    const closedTab = document.getElementById('closed-vouchers-tab');
    const openContent = document.getElementById('open-vouchers-content');
    const closedContent = document.getElementById('closed-vouchers-content');

    if (tabName === 'open') {
      openTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
      openTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50', 'hover:border-gray-300');
      closedTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
      closedTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50', 'hover:border-gray-300');
      openContent.classList.remove('hidden');
      closedContent.classList.add('hidden');
    } else {
      closedTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
      closedTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50', 'hover:border-gray-300');
      openTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
      openTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50', 'hover:border-gray-300');
      closedContent.classList.remove('hidden');
      openContent.classList.add('hidden');
    }
  }

  // Open voucher details in tertiary sidebar
  async function openVoucherDetails(voucherId, tabType) {
    try {
      console.log('Opening voucher details for:', voucherId);

      // Update URL to include certificate ID
      window.history.pushState({}, '', `/certificates/${voucherId}`);

      // Fetch the voucher details
      const response = await fetch(`/account/vouchers/${voucherId}/details`);

      if (!response.ok) {
        console.error('Failed to fetch voucher details:', response.status);
        alert('Error loading voucher details');
        return;
      }

      const html = await response.text();
      console.log('Received voucher details HTML');

      // Load content into tertiary sidebar
      const tertiaryContent = document.getElementById('tertiary-sidebar-content');
      if (!tertiaryContent) {
        console.error('tertiary-sidebar-content not found');
        alert('Error: sidebar not found');
        return;
      }

      tertiaryContent.innerHTML = html;

      // Execute any scripts in the loaded content
      const scripts = tertiaryContent.querySelectorAll('script');
      scripts.forEach(script => {
        const newScript = document.createElement('script');
        if (script.src) {
          newScript.src = script.src;
        } else {
          newScript.textContent = script.textContent;
        }
        document.head.appendChild(newScript);
      });

      // Open the tertiary sidebar
      console.log('Calling openTertiarySidebar');
      if (typeof openTertiarySidebar === 'function') {
        openTertiarySidebar();
        console.log('Tertiary sidebar opened');
      } else {
        console.error('openTertiarySidebar function not found');
      }
    } catch (error) {
      console.error('Error opening voucher details:', error);
      alert('Error loading voucher details: ' + error.message);
    }
  }
</script>
