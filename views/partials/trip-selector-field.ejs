<!-- Trip Selector Field - Reusable partial for all item edit forms -->

<div>
  <label class="block text-sm font-medium text-gray-700 mb-1">Trip Association</label>

  <!-- Display State: Show current trip or prompt to add -->
  <div class="relative">
    <% if (currentTripId) { %>
      <!-- Currently attached to a trip -->
      <div id="tripSelectorDisplay" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 text-sm flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
        <span><%= currentTripName %></span>
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
        </svg>
      </div>
    <% } else { %>
      <!-- Not attached to any trip -->
      <div id="tripSelectorDisplay" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-500 text-sm flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
        <span>+ Add to trip</span>
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
        </svg>
      </div>
    <% } %>

    <!-- Trip Selection Dropdown -->
    <div
      id="tripSelectorDropdown"
      class="hidden absolute top-full left-0 right-0 mt-1 z-50 border border-gray-300 rounded-md bg-white shadow-lg overflow-hidden"
    >
      <div class="max-h-48 overflow-y-auto">
        <% if (availableTrips && availableTrips.length > 0) { %>
          <% availableTrips.forEach(function(trip) { %>
            <% const isCurrentTrip = trip.id === currentTripId; %>
            <button
              type="button"
              class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 border-b border-gray-100 last:border-b-0 transition-colors <%= isCurrentTrip ? 'bg-gray-100 font-medium' : '' %>"
              onclick="selectTrip('<%= trip.id %>', '<%= trip.name.replace(/'/g, "&apos;") %>'); return false;"
            >
              <div class="flex items-center">
                <% if (isCurrentTrip) { %>
                  <svg class="w-4 h-4 text-blue-600 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                <% } else { %>
                  <div class="w-4 h-4 mr-2"></div>
                <% } %>
                <span><%= trip.name %></span>
              </div>
            </button>
          <% }); %>
        <% } else { %>
          <div class="px-3 py-2 text-sm text-gray-500">
            No available trips
          </div>
        <% } %>
      </div>

      <!-- Remove Trip Option (only show if currently attached) -->
      <% if (currentTripId) { %>
        <div class="border-t border-gray-200"></div>
        <button
          type="button"
          class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors font-medium"
          onclick="removeTrip(); return false;"
        >
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <span>Remove from trip</span>
          </div>
        </button>
      <% } %>
    </div>
  </div>

  <!-- Hidden input to store selected tripId -->
  <input
    type="hidden"
    id="tripSelectorInput"
    name="tripId"
    value="<%= currentTripId || '' %>"
  >
</div>

<script>
  // Trip selector functions - defined globally so onclick handlers can access them
  window.tripSelectorState = {
    currentTripId: '<%= currentTripId || "" %>',
    currentTripName: '<%= currentTripName || "" %>'
  };

  window.toggleTripSelector = function() {
    const dropdown = document.getElementById('tripSelectorDropdown');
    if (dropdown) {
      dropdown.classList.toggle('hidden');
    }
    return false;
  };

  window.selectTrip = function(tripId, tripName) {
    window.tripSelectorState.currentTripId = tripId;
    window.tripSelectorState.currentTripName = tripName;

    // Update hidden input
    const input = document.getElementById('tripSelectorInput');
    if (input) {
      input.value = tripId;
    }

    // Update display field text and styling
    const displayField = document.getElementById('tripSelectorDisplay');
    if (displayField) {
      // Update the span text to show trip name instead of "+ Add to trip"
      const span = displayField.querySelector('span');
      if (span) {
        span.textContent = tripName;
      }
      // Change from gray text (standalone) to black text (attached)
      displayField.classList.remove('text-gray-500');
      displayField.classList.add('text-gray-900');
    }

    // Close dropdown
    const dropdown = document.getElementById('tripSelectorDropdown');
    if (dropdown) {
      dropdown.classList.add('hidden');
    }

    console.log('Trip selected:', { tripId, tripName });
    return false;
  };

  window.removeTrip = function() {
    window.tripSelectorState.currentTripId = '';
    window.tripSelectorState.currentTripName = '';

    // Update hidden input
    const input = document.getElementById('tripSelectorInput');
    if (input) {
      input.value = '';
    }

    // Update display field text and styling back to standalone state
    const displayField = document.getElementById('tripSelectorDisplay');
    if (displayField) {
      // Update the span text back to "+ Add to trip"
      const span = displayField.querySelector('span');
      if (span) {
        span.textContent = '+ Add to trip';
      }
      // Change from black text (attached) to gray text (standalone)
      displayField.classList.remove('text-gray-900');
      displayField.classList.add('text-gray-500');
    }

    // Close dropdown
    const dropdown = document.getElementById('tripSelectorDropdown');
    if (dropdown) {
      dropdown.classList.add('hidden');
    }

    console.log('Trip detached');
    return false;
  };

  // Initialize event handlers when DOM is ready
  function initializeTripSelector() {
    const displayField = document.getElementById('tripSelectorDisplay');
    const dropdown = document.getElementById('tripSelectorDropdown');
    const parent = displayField?.parentElement;

    // Setup display field click handler
    if (displayField) {
      displayField.onclick = function(e) {
        e.stopPropagation();
        window.toggleTripSelector();
      };
    }

    // Close dropdown when clicking outside the entire trip selector
    if (parent) {
      document.addEventListener('click', function(e) {
        if (!parent.contains(e.target) && dropdown && !dropdown.classList.contains('hidden')) {
          dropdown.classList.add('hidden');
        }
      });
    }
  }

  // Setup handlers when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTripSelector);
  } else {
    initializeTripSelector();
  }
</script>
