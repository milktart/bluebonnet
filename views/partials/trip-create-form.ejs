<!-- Create Trip Form - Sidebar Version -->
<div class="flex items-start justify-between mb-6">
  <div class="flex items-center">
    <button onclick="if (typeof window.closeSecondarySidebar === 'function') window.closeSecondarySidebar()" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    <h2 class="text-lg font-bold text-gray-900">Create Trip</h2>
  </div>
  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
    <span class="material-symbols-outlined text-blue-600" style="font-size: 16px;">add</span>
  </div>
</div>

<form action="/trips" method="POST" class="space-y-4">
  <div class="grid grid-cols-12 gap-3">
    <div class="col-span-9">
      <label class="block text-sm font-medium text-gray-700 mb-1">Trip Name *</label>
      <input type="text" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Europe Trip 2025" required>
    </div>
    <div class="col-span-3">
      <label class="block text-sm font-medium text-gray-700 mb-1">Confirmed</label>
      <div class="flex items-center justify-center h-10">
        <input type="checkbox" id="isConfirmed" name="isConfirmed" value="on" checked class="w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Departure Date *</label>
      <input type="date" id="departureDate" name="departureDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Return Date *</label>
      <input type="date" id="returnDate" name="returnDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Trip Purpose *</label>
    <select name="purpose" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white" required>
      <option value="">Select a purpose</option>
      <option value="pleasure">Pleasure</option>
      <option value="business">Business</option>
      <option value="other">Other</option>
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Traveling Companions</label>
    <div class="companion-selector space-y-2">
      <div class="flex gap-2">
        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="companionSearch" placeholder="Search companions..." autocomplete="off">
        <button type="button" class="px-4 py-2 text-white text-sm font-medium rounded-md transition-colors focus:outline-none focus:ring-2" id="addCompanionBtn" style="background-color: #10b981; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
          Add
        </button>
      </div>
      <div id="companionDropdown" class="hidden max-h-48 p-1 bg-white border border-gray-200 rounded-lg shadow-lg overflow-y-auto z-10"></div>
      <div id="selectedCompanions" class="flex flex-wrap gap-2"></div>
      <input type="hidden" name="companions" id="companionsHidden">
    </div>
    <p class="text-xs text-gray-500 mt-2">Search for existing companions or type a name and click Add to create a new one</p>
  </div>

  <!-- Companion Permissions Section -->
  <div class="border-t border-gray-200 pt-4">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">Companion Permissions</h3>
    <div id="companionPermissions" class="space-y-2">
      <!-- Will be populated by JavaScript -->
    </div>
    <input type="hidden" name="companionPermissions" id="companionPermissionsJson" value="{}">
  </div>

  <div class="flex items-center pt-4">
    <input type="checkbox" id="defaultCompanionEditPermission" name="defaultCompanionEditPermission" class="w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    <label for="defaultCompanionEditPermission" class="ml-2 text-sm font-medium text-gray-700">
      Allow companions to edit trip items
    </label>
  </div>

  <div class="flex space-x-3 pt-4">
    <button type="submit" class="flex-1 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors" style="background-color: #3b82f6; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
      Create Trip
    </button>
    <button type="button" onclick="if (typeof window.closeSecondarySidebar === 'function') window.closeSecondarySidebar()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
      Cancel
    </button>
  </div>
</form>

<script>
  // Initialize companion search - self-contained implementation
  // Same pattern as edit trip form
  (function() {
    const searchInput = document.getElementById('companionSearch');
    const searchResults = document.getElementById('companionDropdown');
    const companionsContainer = document.getElementById('selectedCompanions');
    const companionsJson = document.getElementById('companionsHidden');
    const addBtn = document.getElementById('addCompanionBtn');

    let selectedCompanions = [];

    if (!searchInput) return;

    // Handle search input
    searchInput.addEventListener('input', async function(e) {
      const query = this.value.trim();

      if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
      }

      try {
        const response = await fetch(`/companions/api/search?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const companions = await response.json();
        const results = companions.filter(c => !selectedCompanions.find(sc => sc.id === c.id));

        if (results.length > 0) {
          searchResults.innerHTML = results.map(companion => `
            <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" data-companion-id="${companion.id}" data-companion-name="${companion.name}" data-companion-email="${companion.email}">
              <div class="font-medium text-gray-900">${companion.name}</div>
              <div class="text-xs text-gray-500">${companion.email}</div>
            </div>
          `).join('');
          searchResults.classList.remove('hidden');
        } else {
          searchResults.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No companions found</div>';
          searchResults.classList.remove('hidden');
        }
      } catch (error) {
        searchResults.innerHTML = '<div class="px-4 py-2 text-sm text-red-500">Error searching companions</div>';
        searchResults.classList.remove('hidden');
      }
    });

    // Handle clicking on a result
    document.addEventListener('click', function(e) {
      const resultItem = e.target.closest('[data-companion-id]');
      if (resultItem && searchResults.contains(resultItem)) {
        const companion = {
          id: resultItem.dataset.companionId,
          name: resultItem.dataset.companionName,
          email: resultItem.dataset.companionEmail,
          isLinked: false,
          isOwn: false
        };
        selectedCompanions.push(companion);

        // Add to display
        const companionEl = document.createElement('div');
        companionEl.className = 'inline-flex items-center gap-2 bg-blue-100 text-blue-900 px-3 py-2 rounded-lg text-sm mr-2 mb-2';
        companionEl.innerHTML = `
          <span>${companion.name}</span>
          <button type="button" class="text-blue-900 hover:text-blue-700 font-bold ml-1 focus:outline-none" style="font-size: 1.2em; line-height: 1;">
            ×
          </button>
        `;

        const removeBtn = companionEl.querySelector('button');
        removeBtn.addEventListener('click', (event) => {
          event.preventDefault();
          selectedCompanions = selectedCompanions.filter(c => c.id !== companion.id);
          companionEl.remove();
          companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
          updateCompanionPermissions();
        });

        companionsContainer.appendChild(companionEl);
        companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
        updateCompanionPermissions();

        // Clear search
        searchInput.value = '';
        searchResults.classList.add('hidden');
      }
      // Close dropdown when clicking outside
      else if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    // Handle Add button click (for creating new companion)
    if (addBtn) {
      addBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (!query) {
          alert('Please enter a name');
          return;
        }

        // Show form to create new companion with name and email
        const email = prompt('Enter email for ' + query + ':');
        if (!email) return;

        try {
          const response = await fetch('/companions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: query, email: email })
          });

          if (response.ok) {
            const newCompanion = await response.json();
            selectedCompanions.push(newCompanion);

            const companionEl = document.createElement('div');
            companionEl.className = 'inline-flex items-center gap-2 bg-blue-100 text-blue-900 px-3 py-2 rounded-lg text-sm mr-2 mb-2';
            companionEl.innerHTML = `
              <span>${newCompanion.name}</span>
              <button type="button" class="text-blue-900 hover:text-blue-700 font-bold ml-1 focus:outline-none" style="font-size: 1.2em; line-height: 1;">
                ×
              </button>
            `;

            const removeBtn = companionEl.querySelector('button');
            removeBtn.addEventListener('click', (event) => {
              event.preventDefault();
              selectedCompanions = selectedCompanions.filter(c => c.id !== newCompanion.id);
              companionEl.remove();
              companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
              updateCompanionPermissions();
            });

            companionsContainer.appendChild(companionEl);
            companionsJson.value = JSON.stringify(selectedCompanions.map(c => c.id));
            updateCompanionPermissions();
            searchInput.value = '';
            searchResults.classList.add('hidden');
          }
        } catch (error) {
          alert('Error creating companion: ' + error.message);
        }
      });
    }
  })();

  function updateCompanionPermissions() {
    const permissionsContainer = document.getElementById('companionPermissions');
    const selectedCompanions = Array.from(document.querySelectorAll('#selectedCompanions > div')).map(el => {
      const name = el.textContent.replace('×', '').trim();
      return { name };
    });

    if (selectedCompanions.length === 0) {
      permissionsContainer.innerHTML = '<p class="text-xs text-gray-500">Add companions to configure permissions</p>';
      return;
    }

    permissionsContainer.innerHTML = selectedCompanions.map((companion, index) => {
      return `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
          <div>
            <p class="text-sm font-medium text-gray-900">${companion.name}</p>
            <p class="text-xs text-gray-500">Trip companion</p>
          </div>
          <label class="flex items-center">
            <input
              type="checkbox"
              class="companion-can-edit w-4 h-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              data-index="${index}"
              onchange="updateCompanionPermissionsJson()"
            >
            <span class="ml-2 text-sm text-gray-700">Can add items</span>
          </label>
        </div>
      `;
    }).join('');
  }

  function updateCompanionPermissionsJson() {
    const permissions = {};
    document.querySelectorAll('.companion-can-edit').forEach((checkbox, index) => {
      if (checkbox.checked) {
        permissions[index] = true;
      }
    });
    document.getElementById('companionPermissionsJson').value = JSON.stringify(permissions);
  }
</script>
