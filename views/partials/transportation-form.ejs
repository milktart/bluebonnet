<!-- Transportation Form - Sidebar Only - Using Preline Components -->

<%
  const isAddMode = !isEditing;
  const submitButtonText = isAddMode ? 'Add Transportation' : 'Update Transportation';
  const headerText = isAddMode ? 'Add Transportation' : 'Edit Transportation';
%>

<div class="sidebar-form-container">
  <div class="flex items-start justify-between mb-6">
    <div class="flex items-center">
      <button onclick="<%= isAddMode ? (tripId ? 'showAddItemMenu()' : 'goBackInSidebar()') : 'closeSecondarySidebar()' %>" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <h2 class="text-lg font-bold text-gray-900"><%= headerText %></h2>
    </div>
    <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0">
      <span class="material-symbols-outlined text-amber-600" style="font-size: 16px;">train</span>
    </div>
  </div>

  <form id="<%= isAddMode ? 'addTransportationForm' : 'editTransportationForm' %>" action="<%= isAddMode ? (tripId ? `/transportation/trips/${tripId}/transportation` : '/transportation/standalone') : `/transportation/${data?.id}` %>" method="POST" class="space-y-4">
    <% if (!isAddMode) { %>
      <input type="hidden" name="_method" value="PUT">
    <% } %>
    <input type="hidden" name="tripId" value="<%= tripId || '' %>">

    <!-- Method & Journey Number -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Method of Travel</label>
        <select name="method" id="<%= isAddMode ? '' : 'edit_transportation_method' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent appearance-none bg-white" required> 
          <option value="">Select method...</option>
          <option value="train" <%= data?.method === 'train' ? 'selected' : '' %>>Train</option>
          <option value="bus" <%= data?.method === 'bus' ? 'selected' : '' %>>Bus</option>
          <option value="ferry" <%= data?.method === 'ferry' ? 'selected' : '' %>>Ferry</option>
          <option value="shuttle" <%= data?.method === 'shuttle' ? 'selected' : '' %>>Shuttle</option>
          <option value="taxi" <%= data?.method === 'taxi' ? 'selected' : '' %>>Taxi/Rideshare</option>
          <option value="subway" <%= data?.method === 'subway' ? 'selected' : '' %>>Subway/Metro</option>
          <option value="tram" <%= data?.method === 'tram' ? 'selected' : '' %>>Tram</option>
          <option value="other" <%= data?.method === 'other' ? 'selected' : '' %>>Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Journey Number</label>
        <input type="text" name="journeyNumber" id="<%= isAddMode ? '' : 'edit_transportation_journeyNumber' %>" value="<%= data?.journeyNumber || '' %>" placeholder="Amtrak 123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
      </div>
    </div>

    <!-- Origin Station/Stop -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Origin Station/Stop</label>
      <input type="text" name="origin" id="<%= isAddMode ? '' : 'edit_transportation_origin' %>" placeholder="Penn Station, New York" value="<%= data?.origin || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
      <input type="hidden" name="originTimezone" id="<%= isAddMode ? 'transportationOriginTimezone' : 'edit_transportation_originTimezone' %>" value="<%= data?.originTimezone || '' %>">
    </div>

    <!-- Destination Station/Stop -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Destination Station/Stop</label>
      <input type="text" name="destination" id="<%= isAddMode ? '' : 'edit_transportation_destination' %>" placeholder="Union Station, Washington DC" value="<%= data?.destination || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
      <input type="hidden" name="destinationTimezone" id="<%= isAddMode ? 'transportationDestinationTimezone' : 'edit_transportation_destinationTimezone' %>" value="<%= data?.destinationTimezone || '' %>">
    </div>

    <!-- Departure Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Departure Date</label>
        <input type="date" name="departureDate" id="<%= isAddMode ? '' : 'edit_transportation_departureDate' %>" value="<%= (data?.departureDate && data.departureDate !== 'undefined') ? data.departureDate : '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Departure Time</label>
        <input type="text" name="departureTime" id="<%= isAddMode ? '' : 'edit_transportation_departureTime' %>" data-time-input value="<%= (data?.departureTime && data.departureTime !== 'undefined') ? data.departureTime : '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
      </div>
    </div>

    <!-- Arrival Date & Time -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Date</label>
        <input type="date" name="arrivalDate" id="<%= isAddMode ? '' : 'edit_transportation_arrivalDate' %>" value="<%= (data?.arrivalDate && data.arrivalDate !== 'undefined') ? data.arrivalDate : '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Time</label>
        <input type="text" name="arrivalTime" id="<%= isAddMode ? '' : 'edit_transportation_arrivalTime' %>" data-time-input value="<%= (data?.arrivalTime && data.arrivalTime !== 'undefined') ? data.arrivalTime : '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
      </div>
    </div>

    <!-- Confirmation & Seat Number -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmation Number</label>
        <input type="text" name="confirmationNumber" id="<%= isAddMode ? '' : 'edit_transportation_confirmationNumber' %>" value="<%= data?.confirmationNumber || '' %>" placeholder="Confirmation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Seat/Coach Number</label>
        <input type="text" name="seat" id="<%= isAddMode ? '' : 'edit_transportation_seat' %>" value="<%= data?.seat || '' %>" placeholder="Coach 3, Seat 14" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
      </div>
    </div>

    <!-- Travel Companions Section -->
    <%- include('./item-companions-section') %>

    <!-- Set context for companion loading -->
    <script>
      window.itemType = 'transportation';
      window.itemId = '<%= data?.id || "" %>';
      window.tripId = '<%= tripId %>';
      // Companions are initialized by parent script (trip-view-sidebar.js) via ensureCompanionsInitialized()
    </script>

    <!-- Buttons -->
    <div class="flex space-x-3 pt-4">
      <button type="submit" class="flex-1 <%= isAddMode ? 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500' : 'bg-green-600 hover:bg-green-700 focus:ring-green-500' %> text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors">
        <%= submitButtonText %>
      </button>
      <button type="button" data-action="closeSecondarySidebar" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
        Cancel
      </button>
    </div>
  </form>

  <% if (!isAddMode) { %>
    <form action="/transportation/<%= data?.id %>?_method=DELETE" method="POST" class="mt-4 pt-4 border-t border-gray-200">
      <input type="hidden" name="tripId" value="<%= tripId || '' %>">
      <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors" onclick="return confirm('Are you sure you want to delete this transportation?')">
        Delete Transportation
      </button>
    </form>
  <% } %>
</div>

<script>
function initializeTransportationDateSync() {
  const departureDateInput = document.querySelector('input[name="departureDate"]');
  const arrivalDateInput = document.querySelector('input[name="arrivalDate"]');

  if (departureDateInput && arrivalDateInput) {
    departureDateInput.addEventListener('change', function() {
      const departureDate = this.value;
      const arrivalDate = arrivalDateInput.value;

      // Case 1: Arrival date is blank - auto-fill with departure date
      if (!arrivalDate) {
        arrivalDateInput.value = departureDate;
      }
      // Case 2: Departure date is after arrival date - update arrival date to match departure date
      else if (departureDate > arrivalDate) {
        arrivalDateInput.value = departureDate;
      }
      // Case 3: Departure date is before arrival date - leave arrival date unchanged
    });
  }
}

function initializeTransportationTimezoneUpdate() {
  const originInput = document.querySelector('input[name="origin"]');
  const destinationInput = document.querySelector('input[name="destination"]');
  const originTimezoneField = document.getElementById('transportationOriginTimezone') || document.getElementById('edit_transportation_originTimezone');
  const destTimezoneField = document.getElementById('transportationDestinationTimezone') || document.getElementById('edit_transportation_destinationTimezone');

  if (originInput && originTimezoneField) {
    async function inferAndUpdateOriginTimezone(location) {
      if (!location || location.trim().length === 0) return;

      try {
        const response = await fetch(`/api/v1/geocode?address=${encodeURIComponent(location)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.timezone) {
            originTimezoneField.value = data.timezone;
            console.log('[Transportation] Updated origin timezone to:', data.timezone);
          }
        }
      } catch (error) {
        console.error('[Transportation] Error inferring origin timezone:', error);
      }
    }

    let timeoutId;
    originInput.addEventListener('blur', function() {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        inferAndUpdateOriginTimezone(this.value);
      }, 500);
    });
  }

  if (destinationInput && destTimezoneField) {
    async function inferAndUpdateDestTimezone(location) {
      if (!location || location.trim().length === 0) return;

      try {
        const response = await fetch(`/api/v1/geocode?address=${encodeURIComponent(location)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.timezone) {
            destTimezoneField.value = data.timezone;
            console.log('[Transportation] Updated destination timezone to:', data.timezone);
          }
        }
      } catch (error) {
        console.error('[Transportation] Error inferring destination timezone:', error);
      }
    }

    let timeoutId;
    destinationInput.addEventListener('blur', function() {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        inferAndUpdateDestTimezone(this.value);
      }, 500);
    });
  }
}

// Call on initial page load
document.addEventListener('DOMContentLoaded', () => {
  initializeTransportationDateSync();
  initializeTransportationTimezoneUpdate();
});

// Also call immediately in case the form is already loaded
initializeTransportationDateSync();
initializeTransportationTimezoneUpdate();

</script>
