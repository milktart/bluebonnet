<!-- Event Form - Sidebar Only - Using Preline Components -->

<%
  const isAddMode = !isEditing;
  const submitButtonText = isAddMode ? 'Add Event' : 'Update Event';
  const headerText = isAddMode ? 'Add Event/Activity' : 'Edit Event';
%>

<%
  const itemType = 'event';
  const itemColor = getItemHexColor(itemType);
%>

<div class="sidebar-form-container" data-item-type="<%= itemType %>">
  <div class="flex items-start justify-between mb-6">
    <div class="flex items-center">
      <button onclick="<%= isAddMode ? (tripId ? 'showAddItemMenu()' : 'closeSecondarySidebar()') : 'closeSecondarySidebar()' %>" class="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors mr-3">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <h2 class="text-lg font-bold text-gray-900"><%= headerText %></h2>
    </div>
    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" data-icon-badge style="background-color: <%= itemColor %>22;">
      <span class="material-symbols-outlined" style="font-size: 16px; color: <%= itemColor %>;">event</span>
    </div>
  </div>

  <form id="<%= isAddMode ? 'addEventForm' : 'editEventForm' %>" action="<%= isAddMode ? (tripId ? `/events/trips/${tripId}/events` : `/events/standalone`) : `/events/${data?.id}` %>" method="POST" class="space-y-4">
    <% if (!isAddMode) { %>
      <input type="hidden" name="_method" value="PUT">
    <% } %>

    <!-- Trip Selector -->
    <%- include('./trip-selector-field', { currentTripId, currentTripName, availableTrips }) %>

    <!-- Event Name -->
    <div class="grid grid-cols-12 gap-3">
      <div class="col-span-9">
        <label class="block text-sm font-medium text-gray-700 mb-1">Event/Activity Name</label>
        <input type="text" name="name" id="<%= isAddMode ? '' : 'edit_event_name' %>" value="<%= data?.name || '' %>" placeholder="Museum Tour, Dinner Reservation, Concert" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
      </div>
      <div class="col-span-3">
        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmed</label>
        <div class="flex items-center justify-center h-10">
          <input type="checkbox" name="isConfirmed" value="on" <% if (typeof data !== 'undefined' && data && typeof data.isConfirmed !== 'undefined') { %><%- data.isConfirmed ? 'checked' : '' %><% } else { %>checked<% } %> class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
        </div>
      </div>
    </div>

    <!-- Location/Venue -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Location/Venue</label>
      <textarea name="location" id="<%= isAddMode ? '' : 'edit_event_location' %>" rows="2" placeholder="Address or venue name with city" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"><%= data?.location || '' %></textarea>
      <input type="hidden" name="timezone" id="<%= isAddMode ? '' : 'edit_event_timezone' %>" value="<%= data?.timezone || '' %>">
    </div>

    <!-- All Day Event Checkbox -->
    <div>
      <label class="flex items-center">
        <input type="checkbox" id="allDayEventCheckbox" name="allDayEvent" class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
        <span class="ml-2 text-sm font-medium text-gray-700">All-day event</span>
      </label>
    </div>

    <!-- Start Date & Time (2 column layout) -->
    <div id="dateTimeLayout" class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
        <input type="date" name="startDate" id="<%= isAddMode ? 'add_event_startDate' : 'edit_event_startDate' %>" value="<%= data?.startDate || '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
      </div>
      <div id="startTimeContainer">
        <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
        <input type="text" name="startTime" id="<%= isAddMode ? 'add_event_startTime' : 'edit_event_startTime' %>" data-time-input value="<%= data?.startTime || '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
      </div>
      <div id="endDateContainer">
        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
        <input type="date" name="endDate" id="<%= isAddMode ? 'add_event_endDate' : 'edit_event_endDate' %>" value="<%= data?.endDate || '' %>" placeholder="YYYY-MM-DD" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
      </div>
      <div id="endTimeContainer">
        <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
        <input type="text" name="endTime" id="<%= isAddMode ? 'add_event_endTime' : 'edit_event_endTime' %>" data-time-input value="<%= data?.endTime || '' %>" placeholder="HH:MM" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
      </div>
    </div>

    <!-- Contact Information -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
      <input type="tel" name="contactPhone" id="<%= isAddMode ? '' : 'edit_event_contactPhone' %>" value="<%= data?.contactPhone || '' %>" placeholder="+1-212-5550123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
      <input type="email" name="contactEmail" id="<%= isAddMode ? '' : 'edit_event_contactEmail' %>" value="<%= data?.contactEmail || '' %>" placeholder="contact@venue.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
    </div>

    <!-- Travel Companions Section -->
    <%- include('./item-companions-section') %>

    <!-- Set context for companion loading -->
    <script>
      window.itemType = 'event';
      window.itemId = '<%= data?.id || "" %>';
      window.tripId = '<%= tripId %>';
      // Companions are initialized by parent script (trip-view-sidebar.js) via ensureCompanionsInitialized()
    </script>

    <!-- Buttons -->
    <div class="flex space-x-3 pt-4">
      <button type="submit" class="flex-1 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 transition-colors" style="background-color: <%= getApproveColor() %>;">
        <%= submitButtonText %>
      </button>
      <button type="button" data-action="closeSecondarySidebar" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
        Cancel
      </button>
    </div>
  </form>

  <% if (!isAddMode) { %>
    <div class="mt-4 pt-4 border-t border-gray-200">
      <button type="button" class="w-full text-white py-2 px-4 rounded-md transition-colors" style="background-color: <%= getDeclineColor() %>; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" onclick="deleteItem('event', '<%= data?.id %>', 'event')">
        Delete Event
      </button>
    </div>
  <% } %>
</div>

<script>
function initializeEventForm() {
  console.log('[Event Form] Initializing event form');

  // Use shared date sync utility for start/end dates
  initializeDateSync('input[name="startDate"]', 'input[name="endDate"]');

  // Use shared timezone inference for location (only works in edit mode since add mode has no location ID)
  const locationFieldId = '<%= isAddMode ? "" : "edit_event_location" %>';
  const timezoneFieldId = '<%= isAddMode ? "event_timezone" : "edit_event_timezone" %>';
  if (locationFieldId) {
    initializeTimezoneInference(locationFieldId, timezoneFieldId);
  }

  // Initialize all-day event toggle - direct inline setup
  const allDayCheckbox = document.getElementById('allDayEventCheckbox');
  const startTimeInput = document.querySelector('input[name="startTime"]');
  const endTimeInput = document.querySelector('input[name="endTime"]');
  const startTimeContainer = document.getElementById('startTimeContainer');
  const endTimeContainer = document.getElementById('endTimeContainer');

  console.log('[Event Form] All-day checkbox found:', !!allDayCheckbox);
  console.log('[Event Form] Time inputs found:', !!startTimeInput, !!endTimeInput);
  console.log('[Event Form] Time containers found:', !!startTimeContainer, !!endTimeContainer);

  if (allDayCheckbox && startTimeInput && endTimeInput && startTimeContainer && endTimeContainer) {
    console.log('[Event Form] Setting up all-day event listener');

    // Function to update time input visibility
    const updateTimeInputStates = () => {
      console.log('[Event Form] All-day checkbox changed to:', allDayCheckbox.checked);

      if (allDayCheckbox.checked) {
        // Hide time containers
        startTimeContainer.classList.add('hidden');
        endTimeContainer.classList.add('hidden');
        // Set all-day event times
        startTimeInput.value = '00:00';
        endTimeInput.value = '23:59';
        console.log('[Event Form] Hiding times, set to 00:00-23:59');
      } else {
        // Show time containers
        startTimeContainer.classList.remove('hidden');
        endTimeContainer.classList.remove('hidden');
        console.log('[Event Form] Showing times');
      }
    };

    // Add change event listener
    allDayCheckbox.addEventListener('change', updateTimeInputStates);
    console.log('[Event Form] Change listener added');

    // On page load, check if this is already an all-day event based on times
    if (startTimeInput.value === '00:00' && endTimeInput.value === '23:59') {
      console.log('[Event Form] Detected all-day event on load');
      allDayCheckbox.checked = true;
      updateTimeInputStates();
    }
  } else {
    console.log('[Event Form] Missing elements, skipping all-day setup');
  }
}
</script>

<script src="/js/form-loader.js" onload="setupEventFormInit();"></script>

