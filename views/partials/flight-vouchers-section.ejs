<!-- Flight Vouchers & Credits Section -->
<div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
      <span class="material-symbols-outlined text-blue-600">card_giftcard</span>
      Vouchers & Credits
    </h3>
  </div>

  <% if (flight.voucherAttachments && flight.voucherAttachments.length > 0) { %>
    <div class="space-y-2">
      <% flight.voucherAttachments.forEach(attachment => { %>
        <div class="bg-white rounded p-3 flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-medium text-gray-900">
                <%= attachment.voucher.issuer %> - <%= attachment.voucher.voucherNumber %>
              </span>
              <span class="px-2 py-0.5 rounded text-xs font-medium
                <% if (attachment.voucher.type === 'TRAVEL_CREDIT') { %>bg-green-100 text-green-800
                <% } else if (attachment.voucher.type === 'UPGRADE_CERT') { %>bg-purple-100 text-purple-800
                <% } else if (attachment.voucher.type === 'COMPANION_CERT') { %>bg-pink-100 text-pink-800
                <% } else if (attachment.voucher.type === 'GIFT_CARD') { %>bg-yellow-100 text-yellow-800
                <% } else { %>bg-gray-100 text-gray-800<% } %>
              ">
                <%= attachment.voucher.type.replace(/_/g, ' ') %>
              </span>
            </div>
            <p class="text-sm text-gray-600">
              <% if (attachment.travelerId && attachment.traveler) { %>
                <span class="font-medium"><%= attachment.traveler.firstName || attachment.traveler.name %></span>
                <% if (attachment.notes) { %>â€¢ <%= attachment.notes %><% } %>
              <% } %>
            </p>
          </div>
          <div class="text-right ml-4">
            <% if (attachment.attachmentValue) { %>
              <p class="text-sm font-medium text-gray-900">
                <%= attachment.voucher.currency %> <%= parseFloat(attachment.attachmentValue).toFixed(2) %>
              </p>
            <% } else { %>
              <p class="text-sm font-medium text-gray-900 text-purple-600">
                Certificate
              </p>
            <% } %>
            <% if (isOwner) { %>
              <button
                type="button"
                onclick="handleRemoveVoucherAttachment('<%= flight.id %>', '<%= attachment.id %>')"
                class="text-xs text-red-600 hover:text-red-800 mt-1"
              >
                Remove
              </button>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>

    <!-- Total -->
    <%
      let total = 0;
      let currency = null;
      let hasMonetaryValues = false;
      flight.voucherAttachments.forEach(att => {
        if (att.attachmentValue) {
          hasMonetaryValues = true;
          if (!currency) currency = att.voucher.currency;
          total += parseFloat(att.attachmentValue);
        }
      });
    %>
    <% if (hasMonetaryValues) { %>
      <div class="mt-3 pt-3 border-t border-blue-200 flex justify-between items-center">
        <span class="text-sm font-medium text-gray-700">Total Vouchers Applied:</span>
        <span class="text-lg font-bold text-blue-600">
          <%= currency %> <%= total.toFixed(2) %>
        </span>
      </div>
    <% } %>
  <% } else { %>
    <p class="text-sm text-gray-600 mb-3">No vouchers attached to this flight yet.</p>
  <% } %>

  <!-- Attach Voucher Button - Full width, appears when empty or after vouchers -->
  <button
    type="button"
    onclick="openVoucherAttachmentPanel('<%= flight.id %>', '<%= typeof trip !== 'undefined' && trip.id ? trip.id : '' %>', '<%= flight.airline %> <%= flight.flightNumber %> - <%= flight.origin %> to <%= flight.destination %>')"
    class="w-full px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 flex items-center justify-center gap-1 mt-3"
  >
    <span class="material-symbols-outlined" style="font-size: 16px;">add</span>
    Attach a Voucher
  </button>
</div>

<script>
  /**
   * Handle remove voucher attachment - wrapper to bridge flight.id from template to global function
   * This is called from the template where we have flight.id context
   */
  function handleRemoveVoucherAttachment(flightId, attachmentId) {
    // Call the global removeVoucherAttachment from voucher-sidebar-manager.js
    if (typeof removeVoucherAttachment === 'function') {
      removeVoucherAttachment(flightId, attachmentId);
    } else {
      alert('Error: Voucher removal function not available');
    }
  }
</script>
