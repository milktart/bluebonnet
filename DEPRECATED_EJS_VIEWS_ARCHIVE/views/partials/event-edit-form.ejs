<div class="flex items-center justify-between mb-6 gap-2">
  <h2 class="text-lg font-bold text-gray-900 truncate">Edit Event</h2>
  <button data-action="closeSecondarySidebar" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>
</div>

<form id="event-edit-form" class="space-y-4" data-event-id="<%= event.id %>">
  <!-- Event Name -->
  <div>
    <label for="eventName" class="block text-sm font-medium text-gray-700 mb-1">Event Name *</label>
    <input type="text" id="eventName" name="name" value="<%= event.name %>" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Conference, Concert">
  </div>

  <!-- Location -->
  <div>
    <label for="eventLocation" class="block text-sm font-medium text-gray-700 mb-1">Location *</label>
    <textarea id="eventLocation" name="location" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., San Francisco, CA"><%= event.location %></textarea>
  </div>

  <!-- All Day Event Checkbox -->
  <div>
    <label class="flex items-center">
      <input type="checkbox" id="allDayEventCheckbox" name="allDayEvent" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
      <span class="ml-2 text-sm font-medium text-gray-700">All-day event</span>
    </label>
  </div>

  <!-- Start Date and Time (2 column layout) -->
  <div id="editDateTimeLayout" class="grid grid-cols-2 gap-4">
    <div>
      <label for="eventStartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
      <input type="date" id="eventStartDate" name="startDate" value="<%= startDate %>" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>
    <div id="editStartTimeContainer">
      <label for="eventStartTime" class="block text-sm font-medium text-gray-700 mb-1">Start Time *</label>
      <input type="text" id="eventStartTime" name="startTime" data-time-input value="<%= startTime %>" placeholder="HH:MM" maxlength="5" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>
    <div id="editEndDateContainer">
      <label for="eventEndDate" class="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
      <input type="date" id="eventEndDate" name="endDate" value="<%= endDate %>" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>
    <div id="editEndTimeContainer">
      <label for="eventEndTime" class="block text-sm font-medium text-gray-700 mb-1">End Time *</label>
      <input type="text" id="eventEndTime" name="endTime" data-time-input value="<%= endTime %>" placeholder="HH:MM" maxlength="5" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>
  </div>

  <!-- Contact Phone -->
  <div>
    <label for="eventContactPhone" class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
    <input type="tel" id="eventContactPhone" name="contactPhone" value="<%= event.contactPhone || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., +1 (555) 123-4567">
  </div>

  <!-- Contact Email -->
  <div>
    <label for="eventContactEmail" class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
    <input type="email" id="eventContactEmail" name="contactEmail" value="<%= event.contactEmail || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., info@example.com">
  </div>

  <!-- Description -->
  <div>
    <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
    <textarea id="eventDescription" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Add notes about this event..."><%= event.description || '' %></textarea>
  </div>

  <!-- Event URL -->
  <div>
    <label for="eventEventUrl" class="block text-sm font-medium text-gray-700 mb-1">Event URL</label>
    <input type="url" id="eventEventUrl" name="eventUrl" value="<%= event.eventUrl || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., https://example.com/event">
  </div>

  <!-- Travel Companions Section -->
  <div class="border-t border-gray-200 pt-4 mt-4">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">
      <span class="material-symbols-outlined" style="display: inline-block; font-size: 18px; margin-right: 8px; vertical-align: middle;">group</span>Travel Companions
    </h3>
    <div id="itemCompanions" class="space-y-2">
      <div class="text-center text-gray-500 text-sm py-2">Loading companions...</div>
    </div>
  </div>

  <!-- Set context for companion loading -->
  <script>
    window.itemType = 'event';
    window.itemId = '<%= event.id %>';
    window.tripId = '<%= event.tripId || "" %>';

    // Load companions on form load
    document.addEventListener('DOMContentLoaded', () => {
      loadItemCompanions(window.itemType, window.itemId, window.tripId);
    });
  </script>

  <!-- Action Buttons -->
  <div class="flex space-x-3 pt-4 border-t border-gray-200">
    <button type="button" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm font-medium" id="saveEventBtn">
      Save Changes
    </button>
    <button type="button" data-action="loadSidebarContent" data-url="/events/<%= event.id %>/sidebar" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors text-sm font-medium">
      Cancel
    </button>
  </div>
</form>

<script>
function initializeEventDateSync() {
  const startDateInput = document.getElementById('eventStartDate');
  const endDateInput = document.getElementById('eventEndDate');

  if (startDateInput && endDateInput) {
    startDateInput.addEventListener('change', function() {
      const startDate = this.value;
      const endDate = endDateInput.value;

      // Case 1: End date is blank - auto-fill with start date
      if (!endDate) {
        endDateInput.value = startDate;
      }
      // Case 2: Start date is after end date - update end date to match start date
      else if (startDate > endDate) {
        endDateInput.value = startDate;
      }
      // Case 3: Start date is before end date - leave end date unchanged
    });
  }
}

function initializeAllDayEvent() {
  const allDayCheckbox = document.getElementById('allDayEventCheckbox');
  const startTimeInput = document.getElementById('eventStartTime');
  const endTimeInput = document.getElementById('eventEndTime');
  const editStartTimeContainer = document.getElementById('editStartTimeContainer');
  const editEndTimeContainer = document.getElementById('editEndTimeContainer');

  if (!allDayCheckbox || !startTimeInput || !endTimeInput) return;

  // Check if current times indicate an all-day event (00:00 and 23:59)
  const isCurrentlyAllDay = () => {
    return startTimeInput.value === '00:00' && endTimeInput.value === '23:59';
  };

  // Function to update time input visibility
  const updateTimeInputStates = () => {
    const isAllDay = allDayCheckbox.checked;

    if (isAllDay) {
      // Hide time containers
      editStartTimeContainer.classList.add('hidden');
      editEndTimeContainer.classList.add('hidden');

      // Set all-day event times
      startTimeInput.value = '00:00';
      endTimeInput.value = '23:59';
    } else {
      // Show time containers
      editStartTimeContainer.classList.remove('hidden');
      editEndTimeContainer.classList.remove('hidden');
    }
  };

  // Add change event listener
  allDayCheckbox.addEventListener('change', updateTimeInputStates);

  // On page load, check if this is already an all-day event based on times
  if (isCurrentlyAllDay()) {
    allDayCheckbox.checked = true;
    updateTimeInputStates();
  }
}

// Call on initial page load
document.addEventListener('DOMContentLoaded', () => {
  initializeEventDateSync();
  initializeAllDayEvent();
});
// Also call immediately in case the form is already loaded
initializeEventDateSync();
initializeAllDayEvent();
</script>

